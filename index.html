<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#0a0a0a" id="theme-meta">
<meta name="mobile-web-app-capable" content="true">
<meta name="apple-mobile-web-app-capable" content="true">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Lean Journey">
<title>LEAN JOURNEY</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════
   APPLE HEALTH × PREMIUM FITNESS — Design System
   Crafted for depth, clarity, and delight
═══════════════════════════════════════════════ */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

:root {
  --accent: #ff3b30; --accent2: #d63028;
  --accent-dim: rgba(255,59,48,0.10);
  --accent-glow: rgba(255,59,48,0.18);
  --green: #34c759; --green2: #28a244;
  --blue: #007aff; --blue2: #0062cc;
  --teal: #5ac8fa;
  --indigo: #5856d6;
  --amber: #ff9f0a;
  --pink: #ff2d55;
  --green-dim: rgba(52,199,89,0.12);
  --blue-dim: rgba(0,122,255,0.12);
  --amber-dim: rgba(255,159,10,0.12);
  --red-dim: rgba(255,59,48,0.10);
  --teal-dim: rgba(90,200,250,0.12);
  --indigo-dim: rgba(88,86,214,0.12);
  /* Legacy compat */
  --gold: #ff3b30; --gold2: #d63028;
  --gold-dim: rgba(255,59,48,0.10);
  --gold-glow: rgba(255,59,48,0.18);
  --transition: all .22s cubic-bezier(.4,0,.2,1);
  --spring: cubic-bezier(.32,.72,0,1);
  --radius: 18px;
  --radius-sm: 12px;
}
[data-theme="dark"] {
  --bg: #000000; --bg2: #0c0c0e; --card: #1c1c1e;
  --card2: #2c2c2e; --card3: #3a3a3c;
  --border: #2c2c2e; --border2: #3a3a3c;
  --text: #ffffff; --text2: rgba(235,235,245,0.72); --text3: rgba(235,235,245,0.60);
  --text4: rgba(235,235,245,0.30);
  --shadow: rgba(0,0,0,0.5);
  --fill: rgba(255,255,255,0.06);
  --fill2: rgba(255,255,255,0.10);
}
[data-theme="light"] {
  --bg: #f2f2f7; --bg2: #e5e5ea; --card: #ffffff;
  --card2: #f2f2f7; --card3: #e5e5ea;
  --border: #e5e5ea; --border2: #d1d1d6;
  --text: #000000; --text2: rgba(60,60,67,0.60); --text3: rgba(60,60,67,0.45);
  --text4: rgba(60,60,67,0.20);
  --shadow: rgba(0,0,0,0.10);
  --fill: rgba(0,0,0,0.04);
  --fill2: rgba(0,0,0,0.07);
}

/* Dot matrix decoration - subtle only */
.dot-matrix {
  position: absolute; opacity: 0.03; pointer-events: none;
  background-image: radial-gradient(circle, var(--accent) 1px, transparent 1px);
  background-size: 14px 14px;
}

/* ═══════════════════════════════════════════════
   RESET & BASE
═══════════════════════════════════════════════ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{width:100%;max-width:520px;margin:0 auto;height:100%;overflow:hidden;
  background:var(--bg);
  font-family:-apple-system,'SF Pro Text','SF Pro Display','Helvetica Neue',sans-serif;
  color:var(--text);
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  transition:background .3s,color .3s;
  letter-spacing:-0.015em}
input,select,textarea{font-family:-apple-system,'SF Pro Text',sans-serif}

/* ═══════════════════════════════════════════════
   APP SHELL
═══════════════════════════════════════════════ */
#app{display:flex;flex-direction:column;height:100dvh;position:relative;overflow:hidden}

/* PAGES */
.page{display:none;flex-direction:column;flex:1;overflow-y:auto;overflow-x:hidden;
  padding-bottom:calc(88px + env(safe-area-inset-bottom, 0px));scrollbar-width:none}
.page::-webkit-scrollbar{display:none}
.page.active{display:flex}

/* NAV — Apple tab bar */
nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);
  width:100%;max-width:520px;
  height:calc(60px + env(safe-area-inset-bottom, 0px));
  padding-bottom:env(safe-area-inset-bottom, 0px);
  background:rgba(28,28,30,0.92);
  backdrop-filter:saturate(180%) blur(32px);
  -webkit-backdrop-filter:saturate(180%) blur(32px);
  border-top:0.5px solid rgba(255,255,255,0.12);
  display:flex;align-items:center;z-index:100}
[data-theme="light"] nav{background:rgba(249,249,249,0.94);border-top-color:rgba(0,0,0,0.10)}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:3px;height:60px;background:none;border:none;
  cursor:pointer;color:var(--text3);transition:color .18s;position:relative;padding:8px 0 4px}
.nav-btn.active{color:var(--accent)}
.nav-btn svg{width:22px;height:22px;stroke-width:1.5;transition:transform .18s}
.nav-btn.active svg{transform:scale(1.05)}
.nav-btn span{font-size:9.5px;font-weight:500;letter-spacing:.1px}

/* PAGE HEADER — Apple large title style */
.page-header{padding:calc(20px + env(safe-area-inset-top,0px)) 20px 16px;
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0;
  background:rgba(0,0,0,0.82);
  backdrop-filter:saturate(180%) blur(24px);
  -webkit-backdrop-filter:saturate(180%) blur(24px);
  position:sticky;top:0;z-index:10;
  border-bottom:0.5px solid rgba(255,255,255,0.08)}
[data-theme="light"] .page-header{background:rgba(242,242,247,0.88);border-bottom-color:rgba(0,0,0,0.08)}
.page-title{font-size:30px;font-weight:700;letter-spacing:-0.6px;color:var(--text);line-height:1}
.page-title span{color:var(--accent)}

/* SECTION LABEL — Apple section style */
.sec-lbl{font-size:12px;font-weight:600;letter-spacing:.3px;text-transform:uppercase;
  color:var(--text3);padding:24px 20px 8px;flex-shrink:0}

/* CARDS — Apple card system */
.card{background:var(--card);border-radius:16px;border:none}
.card-pad{padding:16px}

/* PILLS */
.pill{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;
  border-radius:20px;font-size:11px;font-weight:600;letter-spacing:.1px}
.pill-gold,.pill-accent{background:var(--accent-dim);color:var(--accent)}
.pill-green{background:var(--green-dim);color:var(--green)}
.pill-red{background:var(--red-dim);color:var(--accent)}
.pill-blue{background:var(--blue-dim);color:var(--blue)}

/* PROGRESS BAR */
.prog-track{height:4px;background:var(--fill2);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;border-radius:2px;background:var(--accent);
  transition:width .6s cubic-bezier(.4,0,.2,1)}

/* DIVIDER */
.divider{height:0.5px;background:var(--border);margin:0 16px}

/* INPUTS — Apple HIG style */
.inp-group{padding:8px 20px}
.inp-label{font-size:12px;font-weight:500;color:var(--text3);
  letter-spacing:.1px;margin-bottom:7px;display:block}
.inp{width:100%;background:var(--fill);border:none;
  border-radius:12px;padding:13px 16px;color:var(--text);font-size:16px;
  outline:none;transition:background .18s;-webkit-appearance:none;appearance:none;
  font-family:-apple-system,'SF Pro Text',sans-serif}
.inp:focus{background:var(--fill2);outline:2px solid var(--accent);outline-offset:0}
.inp::placeholder{color:var(--text4)}

/* BUTTONS */
.btn{display:flex;align-items:center;justify-content:center;gap:8px;border:none;
  border-radius:14px;cursor:pointer;
  font-family:-apple-system,'SF Pro Text',sans-serif;
  font-weight:600;transition:opacity .15s, transform .12s;letter-spacing:-.2px}
.btn:active{opacity:.75;transform:scale(.97)}
.btn-primary{background:var(--accent);color:#fff;padding:15px 20px;font-size:16px;width:100%}
.btn-ghost{background:var(--fill);color:var(--text);padding:12px 16px;font-size:14px}
.btn-icon{background:var(--fill);color:var(--text);
  width:36px;height:36px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;
  transition:opacity .15s}
.btn-icon:active{opacity:.6}
.btn-sm{padding:7px 14px;font-size:13px;border-radius:10px}

/* SHEET — iOS-style bottom sheet */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;
  opacity:0;pointer-events:none;transition:opacity .25s;backdrop-filter:blur(4px)}
.overlay.open{opacity:1;pointer-events:all}
.sheet{position:fixed;bottom:0;left:50%;transform:translateX(-50%) translateY(100%);
  width:100%;max-width:520px;background:var(--card);border-radius:22px 22px 0 0;
  z-index:201;
  transition:transform .38s var(--spring);
  padding-bottom:env(safe-area-inset-bottom,0px);max-height:92dvh;overflow-y:auto}
.sheet.open{transform:translateX(-50%) translateY(0)}
.sheet-handle{width:36px;height:4px;background:var(--border2);
  border-radius:2px;margin:10px auto 0}
.sheet-title{font-size:22px;font-weight:700;letter-spacing:-.5px;
  padding:16px 20px 6px;color:var(--text)}
.sheet-title span{color:var(--accent)}
.sheet-sub{font-size:14px;color:var(--text2);padding:0 20px 12px;line-height:1.5}

/* TOAST */
#toast{position:fixed;top:calc(14px + env(safe-area-inset-top,0px));left:50%;
  transform:translateX(-50%) translateY(-80px);
  background:var(--card2);
  border-radius:20px;padding:10px 18px;font-size:13px;font-weight:600;
  color:var(--text);z-index:400;transition:transform .3s var(--spring);
  white-space:nowrap;max-width:calc(100% - 40px);text-align:center;
  box-shadow:0 12px 40px rgba(0,0,0,.4)}
#toast.show{transform:translateX(-50%) translateY(0)}

/* ANIMATIONS */
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.93)}to{opacity:1;transform:scale(1)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.45}}
@keyframes ringIn{from{stroke-dashoffset:251}to{}}
.fade-up{animation:fadeUp .28s ease forwards}
.scale-in{animation:scaleIn .22s ease forwards}
.blink{animation:pulse 1.5s ease-in-out infinite}

/* ═══════════════════════════════════════════════
   HOME PAGE — Apple Health inspired hero
═══════════════════════════════════════════════ */
.hero{background:var(--bg);
  padding:calc(22px + env(safe-area-inset-top,0px)) 20px 20px;
  flex-shrink:0;position:relative;overflow:hidden}
.hero-date{font-size:13px;color:var(--text3);font-weight:500;letter-spacing:.2px;margin-bottom:6px}
.hero-title{font-size:46px;font-weight:800;line-height:1;letter-spacing:-2px;color:var(--text)}
.hero-title em{color:var(--accent);font-style:normal}
.hero-quote{font-size:13px;color:var(--text3);margin-top:14px;line-height:1.6;font-weight:400}

/* STATS GRID — Apple Health metric rings style */
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:16px 16px 0}
.stat-card{background:var(--card);border-radius:18px;
  padding:16px 14px;display:flex;flex-direction:column;gap:4px;cursor:pointer;
  transition:opacity .15s, transform .12s}
.stat-card:active{opacity:.75;transform:scale(.97)}
.stat-val{font-size:24px;font-weight:700;color:var(--text);letter-spacing:-1px;font-variant-numeric:tabular-nums;line-height:1}
.stat-val em{font-size:12px;color:var(--text3);font-style:normal;font-weight:400;letter-spacing:0;margin-left:1px}
.stat-lbl{font-size:10px;color:var(--text3);font-weight:500;letter-spacing:.1px}

/* TDEE / ENERGY CARD */
.tdee-card{margin:0 16px;background:var(--card);
  border-radius:18px;padding:18px}
.tdee-row{display:flex;align-items:flex-start;justify-content:space-between}
.tdee-label{font-size:11px;font-weight:600;color:var(--text3);letter-spacing:.2px;margin-bottom:3px}
.tdee-val{font-size:34px;font-weight:700;color:var(--text);letter-spacing:-1.5px;line-height:1}
.tdee-sub{font-size:12px;color:var(--text3);margin-top:4px}
.tdee-breakdown{display:flex;gap:0;margin-top:16px;border-top:0.5px solid var(--border2);padding-top:16px}
.tdee-item{flex:1;text-align:center}
.tdee-item+.tdee-item{border-left:0.5px solid var(--border2)}
.tdee-item-val{font-size:17px;font-weight:700;color:var(--text);letter-spacing:-.5px;font-variant-numeric:tabular-nums}
.tdee-item-lbl{font-size:10px;color:var(--text3);font-weight:500;margin-top:2px}

/* GOOGLE FIT CONNECT BANNER */
.gfit-banner{margin:10px 16px 0;background:linear-gradient(135deg,rgba(0,122,255,.14),rgba(0,122,255,.06));
  border-radius:18px;padding:16px;
  display:flex;align-items:center;gap:12px}
.gfit-icon{width:40px;height:40px;border-radius:12px;background:rgba(0,122,255,.18);
  display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.gfit-text{flex:1}
.gfit-title{font-size:14px;font-weight:600;color:var(--text)}
.gfit-sub{font-size:12px;color:var(--text3);margin-top:2px}
.gfit-btn{background:var(--blue);color:#fff;border:none;border-radius:10px;
  padding:8px 15px;font-size:13px;font-weight:600;cursor:pointer;flex-shrink:0;
  transition:opacity .15s}
.gfit-btn:active{opacity:.7}

/* HEALTH STATS TILES — Google Fit data */
.health-tiles{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 16px}
.health-tile{background:var(--card);border-radius:18px;padding:18px;position:relative;overflow:hidden;cursor:pointer;transition:opacity .15s,transform .12s}
.health-tile:active{opacity:.8;transform:scale(.97)}
.health-tile-icon{font-size:11px;font-weight:600;color:var(--tile-color, var(--text3));
  display:flex;align-items:center;gap:6px;margin-bottom:12px}
.health-tile-icon svg{width:18px;height:18px;stroke:var(--tile-color, var(--text3));stroke-width:1.8;flex-shrink:0}
.health-tile-val{font-size:28px;font-weight:700;color:var(--text);letter-spacing:-1px;
  font-variant-numeric:tabular-nums;line-height:1}
.health-tile-unit{font-size:13px;font-weight:400;color:var(--text3);letter-spacing:0;margin-left:2px}
.health-tile-sub{font-size:11px;color:var(--text3);margin-top:5px;font-weight:400}
.health-tile-prog{height:3px;background:var(--fill2);border-radius:2px;margin-top:12px;overflow:hidden}
.health-tile-prog-fill{height:100%;border-radius:2px;background:var(--tile-color, var(--accent));transition:width .8s cubic-bezier(.4,0,.2,1)}

.streak-card{margin:0 16px;background:var(--card);
  border-radius:18px;padding:18px;display:flex;align-items:center;gap:16px}
.streak-num{font-size:60px;font-weight:800;line-height:1;color:var(--accent);letter-spacing:-3px}
.streak-dots{display:flex;gap:5px;margin-top:10px;flex-wrap:wrap}
.streak-dot{width:28px;height:4px;border-radius:2px;background:var(--fill2)}
.streak-dot.on{background:var(--accent)}

/* GYM SCHEDULE CARD */
.gym-card{margin:0 16px;background:var(--card);border-radius:18px;overflow:hidden}
.gym-card-hdr{padding:16px;border-bottom:0.5px solid var(--border);
  display:flex;align-items:center;justify-content:space-between}
.gym-time-big{font-size:36px;font-weight:700;letter-spacing:-1.5px;color:var(--accent);line-height:1;margin-top:4px}
.gym-set-btn{background:var(--accent);color:#fff;border:none;border-radius:12px;
  padding:10px 16px;font-size:13px;font-weight:600;cursor:pointer}

/* WATER */
.water-card{margin:0 16px;background:var(--card);border-radius:18px;padding:18px}
.water-cups-row{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap}
.wcup{width:34px;height:44px;border-radius:0 0 8px 8px;
  background:var(--fill);cursor:pointer;position:relative;
  overflow:hidden;transition:all .15s}
.wcup.filled{background:var(--blue-dim)}
.wcup.filled::after{content:'';position:absolute;inset:0;
  background:linear-gradient(to top,var(--blue),rgba(0,122,255,.3))}
.wcup:active{transform:scale(.88)}

/* NOTIFICATION ALERT */
.notif-alert{margin:10px 16px 0;background:var(--accent-dim);
  border-radius:18px;padding:16px;
  display:flex;align-items:center;gap:12px}
.notif-icon{font-size:24px;flex-shrink:0}
.notif-text{flex:1}
.notif-title{font-size:14px;font-weight:600;color:var(--text)}
.notif-sub{font-size:12px;color:var(--text3);margin-top:2px}

/* ═══════════════════════════════════════════════
   WORKOUT PAGE
═══════════════════════════════════════════════ */
.day-scroll{display:flex;gap:8px;padding:14px 16px;overflow-x:auto;scrollbar-width:none;flex-shrink:0}
.day-scroll::-webkit-scrollbar{display:none}
.day-chip{display:flex;flex-direction:column;align-items:center;min-width:50px;
  padding:10px 6px;border-radius:14px;
  background:var(--fill);cursor:pointer;transition:all .18s;flex-shrink:0;position:relative}
.day-chip.selected{background:var(--accent)}
.day-chip.selected .d-name,.day-chip.selected .d-num{color:#fff}
.day-chip.today:not(.selected){outline:2px solid var(--accent);outline-offset:0}
.day-chip.today:not(.selected) .d-name{color:var(--accent)}
.d-name{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text3)}
.d-num{font-size:20px;font-weight:700;color:var(--text);margin-top:2px;letter-spacing:-.5px;font-variant-numeric:tabular-nums}
.d-done-dot{width:5px;height:5px;border-radius:50%;background:var(--green);
  position:absolute;top:5px;right:5px;opacity:0}
.day-chip.logged .d-done-dot{opacity:1}

/* WORKOUT SESSION HEADER */
.session-hdr{margin:0 16px;background:var(--card);border-radius:18px;overflow:hidden}
.sesh-top{padding:16px;border-bottom:0.5px solid var(--border);
  display:flex;align-items:center;justify-content:space-between}
.sesh-name{font-size:22px;font-weight:700;letter-spacing:-.5px;color:var(--text)}
.sesh-prog-row{padding:12px 16px;display:flex;align-items:center;gap:10px}
.sesh-prog-lbl{font-size:12px;color:var(--text3);flex-shrink:0;font-weight:500}
.sesh-prog-val{font-size:12px;color:var(--accent);flex-shrink:0;font-variant-numeric:tabular-nums;font-weight:600}

/* EXERCISE ROW */
.ex-list{margin:10px 16px;display:flex;flex-direction:column;gap:8px}
.ex-card{background:var(--card);border-radius:16px;overflow:hidden;transition:opacity .15s}
.ex-card.active-ex{outline:1.5px solid var(--accent)}
.ex-card.done-ex{opacity:.65}
.ex-header{display:flex;align-items:center;gap:10px;padding:14px;cursor:pointer}
.ex-num-badge{width:32px;height:32px;border-radius:10px;background:var(--fill);
  color:var(--text2);font-size:13px;font-weight:700;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;font-variant-numeric:tabular-nums}
.ex-num-badge.done{background:var(--green-dim);color:var(--green)}
.ex-card.active-ex .ex-num-badge{background:var(--accent-dim);color:var(--accent)}
.ex-name-wrap{flex:1;min-width:0}
.ex-name{font-size:15px;font-weight:600;color:var(--text)}
.ex-plan{font-size:12px;color:var(--text3);margin-top:2px}
.ex-chevron{color:var(--text3);transition:transform .18s;flex-shrink:0}
.ex-card.expanded .ex-chevron{transform:rotate(180deg)}

/* SET LOGGER */
.set-logger{border-top:0.5px solid var(--border);padding:14px;
  background:var(--fill);display:none}
.ex-card.expanded .set-logger{display:block}
/* No suggest box - removed */
.set-inputs-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px}
.set-inp-wrap{display:flex;flex-direction:column;gap:5px}
.set-inp-lbl{font-size:10px;font-weight:600;color:var(--text3);letter-spacing:.2px}
.set-inp{background:var(--card);border:none;
  border-radius:10px;padding:10px 8px;color:var(--text);font-size:18px;
  text-align:center;outline:none;width:100%;
  transition:outline .15s;-webkit-appearance:none;font-variant-numeric:tabular-nums;
  font-family:-apple-system,'SF Pro Text',sans-serif;font-weight:600}
.set-inp:focus{outline:2px solid var(--accent);outline-offset:0}
.set-inp.duration{background:var(--blue-dim)}
.set-inp.duration:focus{outline-color:var(--blue)}

.sets-logged{display:flex;flex-direction:column;gap:4px;margin-bottom:10px}
.set-row-logged{display:flex;align-items:center;gap:8px;padding:8px 10px;
  background:var(--card);border-radius:10px}
.set-row-lbl{font-size:12px;color:var(--text3);flex-shrink:0;font-variant-numeric:tabular-nums;font-weight:500}
.set-row-vals{font-size:13px;color:var(--text);flex:1;font-weight:500}
.set-row-del{color:var(--text3);font-size:16px;cursor:pointer;padding:2px 4px}

.set-btn-row{display:flex;gap:8px}
.log-set-btn{flex:1;background:var(--accent);color:#fff;border:none;border-radius:12px;
  padding:13px;font-weight:600;font-size:14px;cursor:pointer;
  font-family:-apple-system,'SF Pro Text',sans-serif;letter-spacing:-.1px}
.log-set-btn:active{opacity:.75;transform:scale(.97)}
.done-ex-btn{background:var(--green-dim);color:var(--green);border:none;
  border-radius:12px;padding:13px 16px;font-weight:600;
  font-size:13px;cursor:pointer;white-space:nowrap;
  font-family:-apple-system,'SF Pro Text',sans-serif}

/* REST TIMER INLINE */
.rest-timer-bar{display:none;align-items:center;gap:10px;padding:10px 14px;
  border-top:0.5px solid var(--border);background:var(--blue-dim)}
.ex-card.resting .rest-timer-bar{display:flex}
.rest-timer-disp{font-size:30px;font-weight:700;color:var(--blue);letter-spacing:-1px;font-variant-numeric:tabular-nums}
.rest-timer-lbl{font-size:12px;color:var(--text2);flex:1}
.rest-skip-btn{font-size:12px;color:var(--blue);font-weight:600;cursor:pointer;
  background:none;border:none;padding:4px 8px}

/* ═══════════════════════════════════════════════
   CALORIES PAGE — Apple Health inspired (clean)
═══════════════════════════════════════════════ */
/* RING SUMMARY — centered, large, breathing */
.cal-ring-section{padding:24px 16px 8px;display:flex;justify-content:center}
.cal-ring-container{position:relative;width:200px;height:200px;flex-shrink:0}
.cal-ring-container svg{transform:rotate(-90deg)}
.cal-ring-center{position:absolute;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:2px}
.cal-ring-num{font-size:42px;font-weight:700;color:var(--text);letter-spacing:-2px;
  font-variant-numeric:tabular-nums;line-height:1}
.cal-ring-label{font-size:12px;color:var(--text3);font-weight:500;letter-spacing:.1px}

/* CALORIE ROW STATS — below ring */
.cal-stats-row{display:flex;margin:0 16px;gap:1px;background:var(--fill);border-radius:16px;overflow:hidden}
.cal-stat-item{flex:1;padding:14px 12px;background:var(--card);text-align:center}
.cal-stat-item:first-child{border-radius:16px 0 0 16px}
.cal-stat-item:last-child{border-radius:0 16px 16px 0}
.cal-stat-val{font-size:19px;font-weight:700;color:var(--text);letter-spacing:-.8px;font-variant-numeric:tabular-nums}
.cal-stat-lbl{font-size:10px;color:var(--text3);font-weight:500;margin-top:3px}

/* TDEE BREAKDOWN CARD — clean list */
.tdee-breakdown-card{margin:0 16px;background:var(--card);border-radius:18px;overflow:hidden}
.tdee-bd-row{display:flex;align-items:center;padding:14px 16px}
.tdee-bd-row+.tdee-bd-row{border-top:0.5px solid var(--border)}
.tdee-bd-icon{width:34px;height:34px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;margin-right:13px}
.tdee-bd-info{flex:1}
.tdee-bd-label{font-size:14px;font-weight:500;color:var(--text)}
.tdee-bd-sub{font-size:12px;color:var(--text3);margin-top:1px}
.tdee-bd-val{font-size:16px;font-weight:700;color:var(--text);font-variant-numeric:tabular-nums;letter-spacing:-.5px}

/* MACRO BARS */
.macro-bars{padding:0 16px;display:flex;flex-direction:column;gap:0;
  background:var(--card);border-radius:18px;margin:0 16px;overflow:hidden}
.macro-row{display:flex;align-items:center;gap:12px;padding:14px 16px}
.macro-row+.macro-row{border-top:0.5px solid var(--border)}
.macro-lbl{font-size:14px;font-weight:500;color:var(--text);width:58px}
.macro-val{font-size:13px;color:var(--text3);width:72px;text-align:right;
  font-variant-numeric:tabular-nums;font-weight:500}

/* CALORIE BURN SECTION */
.burn-card{margin:0 16px;background:var(--card);
  border-radius:18px;padding:16px;display:flex;align-items:center;gap:14px}
.burn-icon{font-size:28px}
.burn-info{flex:1}
.burn-title{font-size:14px;font-weight:600;color:var(--text)}
.burn-sub{font-size:12px;color:var(--text3);margin-top:2px}
.burn-num{font-size:30px;font-weight:700;color:var(--accent);letter-spacing:-1.5px;font-variant-numeric:tabular-nums}

/* QUICK FOOD GRID */
.qfood-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:0 16px}
.qfood{background:var(--card);border-radius:14px;
  padding:14px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:opacity .15s,transform .12s}
.qfood:active{opacity:.7;transform:scale(.96)}
.qfood-em{font-size:22px;flex-shrink:0}
.qfood-name{font-size:12px;font-weight:600;color:var(--text)}
.qfood-kcal{font-size:11px;color:var(--accent);margin-top:2px;font-weight:500}

/* FOOD LOG LIST */
.food-log-list{padding:0 16px;display:flex;flex-direction:column;gap:0;
  background:var(--card);border-radius:18px;margin:0 16px;overflow:hidden}
.food-item{background:transparent;
  padding:14px 0;display:flex;align-items:center;gap:12px}
.food-item+.food-item{border-top:0.5px solid var(--border)}
.food-em{font-size:24px;flex-shrink:0}
.food-info{flex:1;min-width:0}
.food-name{font-size:14px;font-weight:500;color:var(--text);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.food-macros{font-size:12px;color:var(--text3);margin-top:2px}
.food-kcal{font-size:15px;font-weight:700;color:var(--text);flex-shrink:0;
  font-variant-numeric:tabular-nums;letter-spacing:-.5px}
.food-del{color:var(--text3);cursor:pointer;padding:6px;flex-shrink:0}

/* REMOVE these old calorie-page elements */
.cal-summary{display:none}
.cal-timeline{display:none}

/* ═══════════════════════════════════════════════
   REPORTS PAGE — Apple Health analytics
═══════════════════════════════════════════════ */
.report-tabs{display:flex;background:var(--fill);border-radius:12px;
  padding:3px;margin:0 16px}
.r-tab{flex:1;padding:8px 4px;border-radius:9px;border:none;
  font-size:12px;font-weight:600;color:var(--text3);background:none;cursor:pointer;transition:all .18s;
  font-family:-apple-system,'SF Pro Text',sans-serif}
.r-tab.active{background:var(--card);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,.18)}

.report-kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 16px}
.kpi-card{background:var(--card);border-radius:18px;padding:16px}
.kpi-val{font-size:34px;font-weight:700;line-height:1;color:var(--text);letter-spacing:-1.5px;font-variant-numeric:tabular-nums}
.kpi-val em{font-size:15px;color:var(--text3);font-style:normal;font-weight:400;letter-spacing:0}
.kpi-lbl{font-size:11px;color:var(--text3);font-weight:500;margin-top:4px}
.kpi-change{font-size:11px;font-weight:700;margin-top:6px}
.kpi-change.good{color:var(--green)} .kpi-change.bad{color:var(--accent)}

/* SVG CHART — much taller for proper trend visibility */
.chart-card{margin:0 16px;background:var(--card);
  border-radius:18px;padding:20px;overflow:hidden}
.chart-title{font-size:17px;font-weight:700;letter-spacing:-.4px;margin-bottom:6px;color:var(--text)}
.chart-sub{font-size:12px;color:var(--text3);margin-bottom:20px}
.chart-svg{width:100%;overflow:visible}

/* EXERCISE PROGRESS */
.ex-prog-list{padding:0 16px;display:flex;flex-direction:column;gap:8px}
.ex-prog-card{background:var(--card);border-radius:16px;padding:16px}
.ex-prog-name{font-size:14px;font-weight:600;color:var(--text);margin-bottom:8px}
.ex-prog-nums{display:flex;justify-content:space-between;margin-bottom:6px;align-items:baseline}
.ex-prog-start{font-size:12px;color:var(--text3)}
.ex-prog-now{font-size:15px;color:var(--accent);font-weight:700;font-variant-numeric:tabular-nums}

/* NET DEFICIT CARD */
.deficit-card{margin:0 16px;border-radius:18px;padding:20px;
  background:var(--green-dim)}
.deficit-title{font-size:12px;font-weight:600;color:var(--green);
  letter-spacing:.3px;margin-bottom:8px}
.deficit-num{font-size:52px;font-weight:700;color:var(--green);line-height:1;letter-spacing:-2.5px;font-variant-numeric:tabular-nums}
.deficit-num em{font-size:18px;color:var(--text3);font-style:normal;font-weight:400;letter-spacing:0}
.deficit-breakdown{display:flex;gap:16px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(52,199,89,.2)}
.deficit-item{flex:1;text-align:center}
.deficit-item-val{font-size:15px;font-weight:700;color:var(--text);font-variant-numeric:tabular-nums}
.deficit-item-lbl{font-size:10px;color:var(--text3);font-weight:500;margin-top:3px}

/* ═══════════════════════════════════════════════
   BODY / SETTINGS PAGE
═══════════════════════════════════════════════ */
.body-metrics-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 16px}
.bm-card{background:var(--card);border-radius:18px;padding:16px;cursor:pointer;transition:opacity .15s}
.bm-card:active{opacity:.7}
.bm-val{font-size:36px;font-weight:700;line-height:1;color:var(--text);letter-spacing:-1.5px;font-variant-numeric:tabular-nums}
.bm-val em{font-size:15px;color:var(--text3);font-style:normal;font-weight:400;letter-spacing:0}
.bm-lbl{font-size:11px;color:var(--text3);font-weight:500;margin-top:4px}
.bm-chg{font-size:11px;font-weight:700;margin-top:5px}

.settings-list{padding:0 16px;display:flex;flex-direction:column;gap:1px;
  background:var(--fill);border-radius:16px;overflow:hidden}
.setting-row{background:var(--card);
  padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:opacity .15s}
.setting-row:active{opacity:.7}
.setting-icon{font-size:20px;width:34px;text-align:center}
.setting-info{flex:1}
.setting-title{font-size:15px;font-weight:400;color:var(--text)}
.setting-sub{font-size:12px;color:var(--text3);margin-top:2px}
.setting-right{color:var(--text3)}

/* PHASE CHIP SELECTOR */
.phase-chip{background:var(--card);border:1.5px solid var(--border);border-radius:14px;
  padding:13px 14px;cursor:pointer;transition:all .2s}
.phase-chip.selected{border-color:var(--accent);background:var(--accent-dim)}
.phase-chip-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.phase-chip-name{font-size:13px;font-weight:700;color:var(--text)}
.phase-chip-months{font-size:10px;color:var(--text3);font-weight:600}
.phase-chip-stats{display:flex;gap:8px;flex-wrap:wrap}
.phase-chip-stat{font-size:10px;color:var(--text2)}

/* ROADMAP ROWS */
.roadmap-row{display:flex;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border)}
.roadmap-row:last-child{border-bottom:none}
.roadmap-phase-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:3px}
.roadmap-phase-info{flex:1;min-width:0}
.roadmap-phase-name{font-size:12px;font-weight:700;color:var(--text)}
.roadmap-phase-months{font-size:10px;color:var(--text3);margin-bottom:2px}
.roadmap-phase-targets{font-size:11px;color:var(--text2);line-height:1.5}

/* TARGET PREVIEW CARD */
.target-preview{background:var(--card2);border:1px solid var(--border);border-radius:14px;margin:0 20px;overflow:hidden}
.target-preview-hdr{padding:12px 14px;border-bottom:1px solid var(--border);
  background:linear-gradient(90deg,var(--gold-dim),transparent);
  display:flex;align-items:center;justify-content:space-between}
.target-preview-title{font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:1.5px;color:var(--text)}
.target-preview-badge{font-size:9px;font-weight:700;color:var(--accent);letter-spacing:1px;text-transform:uppercase}
.target-grid{display:grid;grid-template-columns:1fr 1fr;gap:0}
.target-cell{padding:10px 14px;border-right:1px solid var(--border);border-bottom:1px solid var(--border)}
.target-cell:nth-child(even){border-right:none}
.target-cell:nth-last-child(-n+2){border-bottom:none}
.target-cell-lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;font-weight:700}
.target-cell-val{font-family:'DM Mono',monospace;font-size:14px;color:var(--text);margin-top:2px;font-weight:500}
.target-cell-val em{font-size:10px;color:var(--text3);font-style:normal}

/* TOGGLE — see below */

/* ═══════════════════════════════════════════════
   WORKOUT ACTIVE SESSION (full-screen overlay)
═══════════════════════════════════════════════ */
#active-session{position:fixed;inset:0;background:var(--bg);z-index:300;
  display:none;flex-direction:column;max-width:520px;margin:0 auto}
#active-session.open{display:flex}
.as-header{padding:calc(16px + env(safe-area-inset-top,0px)) 16px 12px;
  display:flex;align-items:center;gap:12px;border-bottom:0.5px solid var(--border);flex-shrink:0}
.as-close{background:var(--fill);border-radius:10px;
  width:36px;height:36px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;flex-shrink:0}
.as-title-wrap{flex:1}
.as-session-name{font-size:18px;font-weight:700;letter-spacing:-.5px;color:var(--text)}
.as-ex-count{font-size:12px;color:var(--text3)}
.as-body{flex:1;overflow-y:auto;padding:14px 16px;display:flex;flex-direction:column;gap:12px}
.as-progress-row{display:flex;align-items:center;gap:10px;flex-shrink:0;padding:0 16px 8px}

/* ACTIVE EXERCISE CARD */
.aex-card{background:var(--card);border:1.5px solid var(--accent);border-radius:20px;overflow:hidden}
.aex-hdr{padding:16px;border-bottom:0.5px solid var(--border);background:var(--accent-dim)}
.aex-num{font-size:11px;font-weight:600;color:var(--accent);letter-spacing:.4px}
.aex-name{font-size:24px;font-weight:700;letter-spacing:-.5px;color:var(--text);margin-top:3px}
.aex-plan-detail{font-size:12px;color:var(--text3);margin-top:3px}

/* SET INPUT AREA */
.aex-set-area{padding:0 16px 14px}
.aex-set-title{font-size:11px;font-weight:600;color:var(--text3);letter-spacing:.2px;margin:14px 0 10px}
.aex-inputs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px}
.aex-inp-wrap{display:flex;flex-direction:column;gap:5px}
.aex-inp-lbl{font-size:10px;font-weight:600;color:var(--text3);letter-spacing:.2px;text-align:center}
.aex-inp{background:var(--fill2);border:none;
  border-radius:12px;padding:12px 8px;color:var(--text);font-size:22px;
  text-align:center;outline:none;width:100%;
  transition:outline .15s;-webkit-appearance:none;font-weight:700;
  font-family:-apple-system,'SF Pro Text',monospace;font-variant-numeric:tabular-nums}
.aex-inp:focus{outline:2px solid var(--accent);outline-offset:0}

/* SETS LOGGED MINI LIST */
.aex-sets-done{padding:0 16px;display:flex;flex-direction:column;gap:5px;margin-bottom:10px}
.aex-set-logged{display:flex;align-items:center;gap:8px;padding:8px 10px;
  background:var(--fill);border-radius:10px}
.aex-set-lbl{font-size:11px;color:var(--text3);width:40px;font-weight:500}
.aex-set-vals{font-size:13px;color:var(--text);flex:1;font-weight:500}
.aex-set-del{color:var(--text3);cursor:pointer;font-size:16px;padding:0 4px}

/* LOG SET BUTTON */
.aex-log-btn{margin:0 16px 10px;background:var(--accent);color:#fff;border:none;
  border-radius:14px;padding:15px;
  font-family:-apple-system,'SF Pro Text',sans-serif;font-weight:700;
  font-size:15px;cursor:pointer;width:calc(100% - 32px)}
.aex-log-btn:active{opacity:.75;transform:scale(.97)}

/* REST TIMER FULL */
.rest-overlay{position:fixed;inset:0;background:rgba(0,0,0,.97);z-index:400;
  display:none;flex-direction:column;align-items:center;justify-content:center;
  max-width:520px;margin:0 auto;backdrop-filter:blur(24px)}
.rest-overlay.open{display:flex}
.rest-title{font-size:12px;font-weight:600;color:var(--text3);
  letter-spacing:2px;text-transform:uppercase;margin-bottom:8px}
.rest-big{font-size:100px;font-weight:800;letter-spacing:-4px;
  color:var(--blue);line-height:1;margin-bottom:4px;font-variant-numeric:tabular-nums}
.rest-next{font-size:14px;color:var(--text3);margin-bottom:32px;text-align:center;padding:0 40px}
.rest-skip{background:var(--fill);color:var(--text);border:none;
  border-radius:14px;padding:14px 40px;font-weight:600;
  font-size:15px;cursor:pointer;font-family:-apple-system,'SF Pro Text',sans-serif}

/* DONE BUTTON */
.aex-done-btn{margin:0 16px 16px;background:var(--green-dim);color:var(--green);
  border:none;border-radius:12px;padding:13px;
  font-family:-apple-system,'SF Pro Text',sans-serif;font-weight:700;font-size:14px;cursor:pointer;
  width:calc(100% - 32px)}
.aex-done-btn:active{opacity:.7}

.as-footer{padding:12px 16px;padding-bottom:calc(12px + env(safe-area-inset-bottom,0px));
  border-top:0.5px solid var(--border);display:flex;gap:8px;flex-shrink:0}

/* SESSION COMPLETE */
.session-complete{position:fixed;inset:0;background:var(--bg);z-index:500;
  display:none;flex-direction:column;align-items:center;justify-content:center;
  padding:40px 24px;max-width:520px;margin:0 auto}
.session-complete.open{display:flex}
.sc-icon{font-size:64px;margin-bottom:16px}

/* ═══════════════════════════════════════════════
   RESPONSIVE
═══════════════════════════════════════════════ */
@media (min-width:520px){
  html,body{max-width:520px}
  .page-title{font-size:32px}
  .hero-title{font-size:48px}
}
@media (max-width:360px){
  .stat-val{font-size:18px}
  .wcup{width:28px;height:36px}
  .streak-num{font-size:44px}
  .gym-time-big{font-size:28px}
  .page-title{font-size:26px}
}
@media (max-width:320px){
  .hero-title{font-size:32px}
  .set-inputs-row,.aex-inputs{grid-template-columns:1fr 1fr 1fr}
  .aex-inp{font-size:16px;padding:9px 4px}
}

/* MILESTONE CARDS */
.milestone-card{background:var(--card);border-radius:18px;
  padding:16px;cursor:pointer;transition:opacity .15s;position:relative;overflow:hidden}
.milestone-card:active{opacity:.75}
.milestone-card.current-phase{outline:1.5px solid var(--accent)}
.milestone-card.achieved{outline:1.5px solid var(--green)}
.milestone-card.future{opacity:.5}
.milestone-badge{position:absolute;top:12px;right:12px;font-size:10px;font-weight:600;
  letter-spacing:.1px;padding:4px 10px;border-radius:20px}
.milestone-badge.achieved{background:var(--green-dim);color:var(--green)}
.milestone-badge.current{background:var(--accent-dim);color:var(--accent)}
.milestone-badge.future{background:var(--fill);color:var(--text3)}
.milestone-period{font-size:11px;font-weight:600;color:var(--text3);
  letter-spacing:.2px;margin-bottom:5px}
.milestone-title{font-size:20px;font-weight:700;letter-spacing:-.5px;color:var(--text);margin-bottom:10px}
.milestone-stats-row{display:flex;gap:10px;flex-wrap:wrap}
.milestone-stat{display:flex;flex-direction:column;gap:2px;min-width:60px}
.milestone-stat-val{font-size:14px;font-weight:600;color:var(--text);font-variant-numeric:tabular-nums}
.milestone-stat-lbl{font-size:10px;color:var(--text3);font-weight:500}

/* PHASE TARGET CARD */
.phase-target-card{background:var(--accent-dim);border-radius:18px;padding:18px}
.phase-target-title{font-size:22px;font-weight:700;letter-spacing:-.5px;
  color:var(--accent);margin-bottom:4px}
.phase-target-sub{font-size:13px;color:var(--text3);margin-bottom:16px;line-height:1.5}
.phase-targets-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.phase-target-item{background:rgba(0,0,0,.15);border-radius:12px;padding:12px}
.phase-target-item-val{font-size:15px;font-weight:700;color:var(--text);font-variant-numeric:tabular-nums}
.phase-target-item-lbl{font-size:10px;color:var(--text3);font-weight:500;margin-top:3px}

/* PHASE OPTION CARDS */
.phase-option-card{background:var(--card);border-radius:14px;
  padding:14px 16px;cursor:pointer;transition:opacity .15s}
.phase-option-card:active,.phase-option-card.selected{opacity:.75;outline:1.5px solid var(--accent)}
.phase-option-year{font-size:11px;font-weight:600;color:var(--text3);letter-spacing:.2px;margin-bottom:3px}
.phase-option-name{font-size:15px;font-weight:600;color:var(--text)}
.phase-option-months{font-size:12px;color:var(--text3);margin-top:3px}

/* SESSION COMPLETE DUPLICATE REMOVED */
.sc-title{font-size:48px;font-weight:800;text-align:center;letter-spacing:-2.5px;
  color:var(--accent);margin-bottom:8px}
.sc-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;margin:20px 0}
.sc-stat{background:var(--card);border-radius:18px;padding:16px;text-align:center}
.sc-stat-val{font-size:34px;font-weight:800;color:var(--text);letter-spacing:-1.5px;font-variant-numeric:tabular-nums}
.sc-stat-lbl{font-size:11px;color:var(--text3);font-weight:500;margin-top:3px}

/* TOGGLE SWITCH */
.toggle-sw{position:relative;width:44px;height:26px;flex-shrink:0}
.toggle-sw input{opacity:0;width:0;height:0}
.toggle-track{position:absolute;inset:0;background:var(--fill2);border-radius:13px;
  cursor:pointer;transition:.3s}
.toggle-track::before{content:'';position:absolute;height:20px;width:20px;left:3px;bottom:3px;
  background:#fff;border-radius:50%;transition:.3s;box-shadow:0 1px 4px rgba(0,0,0,.3)}
input:checked + .toggle-track{background:var(--green)}
input:checked + .toggle-track::before{transform:translateX(18px)}
</style>
</head>
<body>
<div id="app">

<!-- ══════════ HOME ══════════ -->
<div class="page active" id="page-home">
  <div class="hero">
    <div class="hero-date" id="hero-date"></div>
    <div class="hero-title">LET'S<br><em id="hero-word">BUILD.</em></div>
    <div class="hero-quote" id="hero-quote"></div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><div class="stat-val" id="h-weight">—<em>kg</em></div><div class="stat-lbl">Weight</div></div>
    <div class="stat-card"><div class="stat-val" id="h-streak">0<em>d</em></div><div class="stat-lbl">Streak</div></div>
    <div class="stat-card"><div class="stat-val" id="h-cal">—<em>c</em></div><div class="stat-lbl">Eaten</div></div>
  </div>

  <!-- ENERGY BALANCE -->
  <div class="sec-lbl">Energy Balance</div>
  <div class="tdee-card" id="tdee-card">
    <div class="tdee-row">
      <div>
        <div class="tdee-label">Net Available</div>
        <div class="tdee-val" id="tdee-net">—</div>
        <div class="tdee-sub" id="tdee-sub">Including BMR + workout burn</div>
      </div>
      <div style="text-align:right">
        <div class="tdee-label">TDEE</div>
        <div style="font-size:22px;font-weight:700;color:var(--text3);letter-spacing:-1px;margin-top:4px" id="tdee-total">—</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">kcal / day</div>
      </div>
    </div>
    <div class="tdee-breakdown">
      <div class="tdee-item">
        <div class="tdee-item-val" id="tdee-bmr">—</div>
        <div class="tdee-item-lbl">BMR</div>
      </div>
      <div class="tdee-item">
        <div class="tdee-item-val" id="tdee-neat">~150</div>
        <div class="tdee-item-lbl">NEAT</div>
      </div>
      <div class="tdee-item">
        <div class="tdee-item-val" id="tdee-workout-kcal">0</div>
        <div class="tdee-item-lbl">Workout</div>
      </div>
      <div class="tdee-item">
        <div class="tdee-item-val" id="tdee-eaten">—</div>
        <div class="tdee-item-lbl">Eaten</div>
      </div>
    </div>
  </div>

  <!-- GOOGLE FIT CONNECT BANNER -->
  <div class="gfit-banner" id="gfit-banner">
    <div class="gfit-icon">❤️</div>
    <div class="gfit-text">
      <div class="gfit-title">Connect Google Fit</div>
      <div class="gfit-sub">Sync steps, heart rate & real-time burn</div>
    </div>
    <button class="gfit-btn" id="gfit-connect-btn">Connect</button>
  </div>

  <!-- GOOGLE FIT HEALTH TILES -->
  <div class="sec-lbl">Activity</div>
  <div class="health-tiles">
    <div class="health-tile" style="--tile-color:var(--green)">
      <div class="health-tile-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
        Steps
      </div>
      <div class="health-tile-val" id="fit-steps">—<span class="health-tile-unit"></span></div>
      <div class="health-tile-sub" id="fit-steps-sub">Goal: 10,000</div>
      <div class="health-tile-prog"><div class="health-tile-prog-fill" id="fit-steps-bar" style="width:0%"></div></div>
    </div>
    <div class="health-tile" style="--tile-color:var(--accent)">
      <div class="health-tile-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        Heart Rate
      </div>
      <div class="health-tile-val" id="fit-hr">—<span class="health-tile-unit">bpm</span></div>
      <div class="health-tile-sub" id="fit-hr-sub">Resting heart rate</div>
      <div class="health-tile-prog"><div class="health-tile-prog-fill" id="fit-hr-bar" style="width:0%"></div></div>
    </div>
    <div class="health-tile" style="--tile-color:var(--indigo)">
      <div class="health-tile-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9z"/></svg>
        Sleep
      </div>
      <div class="health-tile-val" id="fit-sleep">—<span class="health-tile-unit">h</span></div>
      <div class="health-tile-sub" id="fit-sleep-sub">Goal: 8 hrs</div>
      <div class="health-tile-prog"><div class="health-tile-prog-fill" id="fit-sleep-bar" style="width:0%"></div></div>
    </div>
    <div class="health-tile" style="--tile-color:var(--teal)">
      <div class="health-tile-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
        Heart Pts
      </div>
      <div class="health-tile-val" id="fit-pts">—<span class="health-tile-unit">pts</span></div>
      <div class="health-tile-sub" id="fit-pts-sub">Weekly goal: 150</div>
      <div class="health-tile-prog"><div class="health-tile-prog-fill" id="fit-pts-bar" style="width:0%"></div></div>
    </div>
  </div>

  <!-- STREAK -->
  <div class="sec-lbl">Consistency</div>
  <div class="streak-card">
    <div class="streak-num" id="streak-big">0</div>
    <div style="flex:1">
      <div style="font-size:16px;font-weight:700;color:var(--text)">Day Streak</div>
      <div style="font-size:13px;color:var(--text3);margin-top:2px">Never miss twice</div>
      <div class="streak-dots" id="streak-dots"></div>
    </div>
  </div>

  <!-- GYM TIME CARD -->
  <div class="sec-lbl">Gym Schedule</div>
  <div class="gym-card">
    <div class="gym-card-hdr">
      <div>
        <div style="font-size:12px;color:var(--text3);font-weight:500">Today's Gym Time</div>
        <div class="gym-time-big" id="gym-time-display">Not Set</div>
        <div style="font-size:12px;color:var(--text3)" id="preworkout-info"></div>
      </div>
      <button class="gym-set-btn" id="set-gym-time-btn">Set Time</button>
    </div>
    <div style="padding:14px 16px" id="gym-countdown-wrap">
      <div style="font-size:12px;color:var(--text3);margin-bottom:5px;font-weight:500">Time Until Gym</div>
      <div style="font-size:26px;font-weight:700;color:var(--text);letter-spacing:-1px" id="gym-countdown">—</div>
    </div>
  </div>

  <!-- NOTIFICATIONS BANNER -->
  <div class="notif-alert" id="notif-banner" style="display:none">
    <div class="notif-icon">⏰</div>
    <div class="notif-text">
      <div class="notif-title" id="notif-title">Pre-Workout Time!</div>
      <div class="notif-sub" id="notif-sub">Take your pre-workout now — gym in 45 min</div>
    </div>
  </div>

  <!-- WATER -->
  <div class="sec-lbl">Hydration — 3.5L Daily</div>
  <div class="water-card">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <div style="font-size:15px;font-weight:600;color:var(--text)">Water Intake</div>
        <div style="font-size:12px;color:var(--text3);margin-top:3px">Each cup = 500ml · Target 7 cups</div>
      </div>
      <div style="font-size:26px;font-weight:700;color:var(--blue);letter-spacing:-1px" id="water-ml">0.0L</div>
    </div>
    <div class="water-cups-row" id="water-cups"></div>
  </div>
  <div style="height:16px"></div>
</div>

<!-- ══════════ WORKOUT ══════════ -->
<div class="page" id="page-workout">
  <div class="page-header">
    <div>
      <div class="page-title">Workout</div>
      <div style="font-size:12px;color:var(--text3);margin-top:3px" id="workout-today-lbl"></div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn-icon" id="start-session-btn" title="Start Active Session">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
      </button>
    </div>
  </div>

  <div class="day-scroll" id="day-scroll"></div>

  <div class="sec-lbl" id="workout-day-lbl">Sunday — Upper Strength</div>
  <div class="session-hdr">
    <div class="sesh-top">
      <div>
        <div class="sesh-name" id="sesh-name">UPPER STRENGTH</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px" id="sesh-meta">Chest + Back · ~55 min</div>
      </div>
      <div class="pill pill-gold" id="sesh-tag">Day 1</div>
    </div>
    <div class="sesh-prog-row">
      <div class="sesh-prog-lbl">Progress</div>
      <div style="flex:1" class="prog-track"><div class="prog-fill" id="sesh-prog-bar" style="width:0%"></div></div>
      <div class="sesh-prog-val" id="sesh-prog-val">0/0</div>
    </div>
  </div>

  <div class="ex-list" id="ex-list"></div>
  <div style="height:12px"></div>
</div>

<!-- ══════════ CALORIES ══════════ -->
<div class="page" id="page-cal">
  <div class="page-header">
    <div class="page-title">Calories</div>
    <div style="font-size:12px;color:var(--text3);font-weight:500" id="cal-date-lbl"></div>
  </div>

  <!-- MAIN RING — centered, Apple Health style -->
  <div class="cal-ring-section">
    <div class="cal-ring-container">
      <svg width="200" height="200" viewBox="0 0 200 200">
        <!-- Track -->
        <circle cx="100" cy="100" r="82" fill="none" stroke="var(--fill2)" stroke-width="14"/>
        <!-- Eaten arc -->
        <circle id="ring-arc" cx="100" cy="100" r="82" fill="none" stroke="var(--accent)"
          stroke-width="14" stroke-linecap="round"
          stroke-dasharray="515" stroke-dashoffset="515"
          style="transition:stroke-dashoffset .7s cubic-bezier(.4,0,.2,1)"/>
        <!-- Inner BMR ring -->
        <circle cx="100" cy="100" r="60" fill="none" stroke="var(--fill2)" stroke-width="10"/>
        <circle id="ring-bmr" cx="100" cy="100" r="60" fill="none" stroke="var(--green)"
          stroke-width="10" stroke-linecap="round"
          stroke-dasharray="377" stroke-dashoffset="377"
          style="transition:stroke-dashoffset .7s cubic-bezier(.4,0,.2,1)"/>
      </svg>
      <div class="cal-ring-center">
        <div class="cal-ring-num" id="cal-remain">—</div>
        <div class="cal-ring-label">remaining</div>
      </div>
    </div>
  </div>

  <!-- STATS ROW -->
  <div class="cal-stats-row">
    <div class="cal-stat-item">
      <div class="cal-stat-val" id="cal-eaten">0</div>
      <div class="cal-stat-lbl">Eaten</div>
    </div>
    <div class="cal-stat-item" style="border-left:0.5px solid var(--border);border-right:0.5px solid var(--border)">
      <div class="cal-stat-val" id="cal-burned-txt" style="color:var(--accent)">0</div>
      <div class="cal-stat-lbl">Burned</div>
    </div>
    <div class="cal-stat-item">
      <div class="cal-stat-val" id="ring-pct">0%</div>
      <div class="cal-stat-lbl">of Goal</div>
    </div>
  </div>

  <!-- MACROS — grouped card -->
  <div class="sec-lbl">Macros</div>
  <div class="macro-bars">
    <div class="macro-row">
      <div class="macro-lbl" style="color:var(--blue);font-weight:600">Protein</div>
      <div style="flex:1" class="prog-track"><div class="prog-fill" id="bar-p" style="width:0%;background:var(--blue)"></div></div>
      <div class="macro-val"><span id="val-p">0</span>/<span id="tgt-p">140</span>g</div>
    </div>
    <div class="macro-row">
      <div class="macro-lbl" style="color:var(--accent);font-weight:600">Carbs</div>
      <div style="flex:1" class="prog-track"><div class="prog-fill" id="bar-c" style="width:0%"></div></div>
      <div class="macro-val"><span id="val-c">0</span>/<span id="tgt-c">240</span>g</div>
    </div>
    <div class="macro-row">
      <div class="macro-lbl" style="color:var(--amber);font-weight:600">Fat</div>
      <div style="flex:1" class="prog-track"><div class="prog-fill" id="bar-f" style="width:0%;background:var(--amber)"></div></div>
      <div class="macro-val"><span id="val-f">0</span>/<span id="tgt-f">60</span>g</div>
    </div>
  </div>

  <!-- ENERGY BREAKDOWN -->
  <div class="sec-lbl">Energy</div>
  <div class="tdee-breakdown-card">
    <div class="tdee-bd-row">
      <div class="tdee-bd-icon" style="background:var(--accent-dim)">🎯</div>
      <div class="tdee-bd-info">
        <div class="tdee-bd-label">Daily Target</div>
        <div class="tdee-bd-sub">Your calorie goal</div>
      </div>
      <div class="tdee-bd-val" id="tdb-target">—</div>
    </div>
    <div class="tdee-bd-row">
      <div class="tdee-bd-icon" style="background:var(--blue-dim)">🧠</div>
      <div class="tdee-bd-info">
        <div class="tdee-bd-label">BMR</div>
        <div class="tdee-bd-sub">Resting metabolic burn</div>
      </div>
      <div class="tdee-bd-val" id="tdb-bmr" style="color:var(--blue)">—</div>
    </div>
    <div class="tdee-bd-row">
      <div class="tdee-bd-icon" style="background:var(--green-dim)">🚶</div>
      <div class="tdee-bd-info">
        <div class="tdee-bd-label">NEAT</div>
        <div class="tdee-bd-sub">Daily activity burn</div>
      </div>
      <div class="tdee-bd-val" id="tdb-neat" style="color:var(--green)">~150</div>
    </div>
    <div class="tdee-bd-row">
      <div class="tdee-bd-icon" style="background:var(--accent-dim)">🏋️</div>
      <div class="tdee-bd-info">
        <div class="tdee-bd-label">Workout</div>
        <div class="tdee-bd-sub">Today's session</div>
      </div>
      <div class="tdee-bd-val" id="tdb-workout" style="color:var(--accent)">0</div>
    </div>
    <div class="tdee-bd-row" style="border-top:1px solid var(--border2)">
      <div class="tdee-bd-icon" style="background:var(--fill2)">⚡</div>
      <div class="tdee-bd-info">
        <div class="tdee-bd-label" style="font-weight:700">Total TDEE</div>
        <div class="tdee-bd-sub">All burns combined</div>
      </div>
      <div class="tdee-bd-val" id="tdb-total" style="font-size:18px;font-weight:800">—</div>
    </div>
  </div>

  <!-- QUICK ADD -->
  <div class="sec-lbl">Quick Add</div>
  <div class="qfood-grid" id="qfood-grid"></div>

  <!-- TODAY'S LOG -->
  <div class="sec-lbl">Today's Log</div>
  <div class="food-log-list" id="food-log-list">
    <div style="color:var(--text3);font-size:14px;text-align:center;padding:24px;font-weight:400">No food logged yet</div>
  </div>
  <div style="height:16px"></div>
</div>

<!-- ══════════ REPORTS ══════════ -->
<div class="page" id="page-reports">
  <div class="page-header">
    <div class="page-title">Reports</div>
  </div>

  <div style="padding:16px 16px 0">
    <div class="report-tabs" id="report-tabs">
      <button class="r-tab active" data-period="week">Week</button>
      <button class="r-tab" data-period="month">Month</button>
      <button class="r-tab" data-period="quarter">Quarter</button>
      <button class="r-tab" data-period="year">Year</button>
    </div>
  </div>

  <!-- NET DEFICIT -->
  <div class="sec-lbl">Deficit</div>
  <div class="deficit-card">
    <div class="deficit-title">Net Calorie Deficit</div>
    <div class="deficit-num"><span id="deficit-num">0</span><em> kcal</em></div>
    <div style="font-size:13px;color:rgba(52,199,89,.8);margin-top:6px;font-weight:500" id="deficit-sub">Keep going — deficit = fat loss</div>
    <div class="deficit-breakdown">
      <div class="deficit-item">
        <div class="deficit-item-val" id="r-consumed">0</div>
        <div class="deficit-item-lbl">Consumed</div>
      </div>
      <div class="deficit-item">
        <div class="deficit-item-val" id="r-burned">0</div>
        <div class="deficit-item-lbl">Burned</div>
      </div>
      <div class="deficit-item">
        <div class="deficit-item-val" id="r-bmr">0</div>
        <div class="deficit-item-lbl">BMR Total</div>
      </div>
    </div>
  </div>

  <div class="sec-lbl">Key Metrics</div>
  <div class="report-kpi-grid" id="report-kpis"></div>

  <!-- WEIGHT CHART — tall enough to show trend clearly -->
  <div class="sec-lbl">Weight Trend</div>
  <div class="chart-card">
    <div class="chart-title" id="weight-chart-title">Weight</div>
    <div class="chart-sub">Progress over selected period</div>
    <svg class="chart-svg" id="weight-chart" viewBox="0 0 340 180" width="100%" height="180" preserveAspectRatio="none"></svg>
  </div>

  <div class="sec-lbl">Strength Progress</div>
  <div class="ex-prog-list" id="ex-prog-list"></div>

  <!-- BODY CHART — also taller -->
  <div class="sec-lbl">Body Trends</div>
  <div class="chart-card">
    <div class="chart-title">Waist & Resting HR</div>
    <div class="chart-sub">Measurements over time</div>
    <svg class="chart-svg" id="body-chart" viewBox="0 0 340 160" width="100%" height="160" preserveAspectRatio="none"></svg>
  </div>
  <div style="height:16px"></div>
</div>

<!-- ══════════ PROFILE ══════════ -->
<div class="page" id="page-profile">
  <div class="page-header">
    <div class="page-title">Profile</div>
  </div>

  <div class="sec-lbl">Body Stats</div>
  <div class="body-metrics-grid" id="body-metrics"></div>

  <div style="padding:10px 16px">
    <button class="btn btn-primary" id="log-body-btn">+ Log Today's Stats</button>
  </div>

  <div class="sec-lbl">Push-Up Tracker</div>
  <div style="padding:0 16px">
    <div class="card card-pad" style="display:flex;align-items:center;gap:14px">
      <div style="flex:1">
        <div style="font-size:15px;font-weight:600;color:var(--text)">Today's Push-Ups</div>
        <div style="font-size:12px;color:var(--text3);margin-top:3px">Track every upper body session</div>
      </div>
      <div style="font-size:46px;font-weight:800;color:var(--accent);letter-spacing:-2px;line-height:1" id="pushup-val">0</div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="btn-icon" id="pu-up"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="18 15 12 9 6 15"/></svg></button>
        <button class="btn-icon" id="pu-dn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg></button>
      </div>
    </div>
  </div>

  <div class="sec-lbl">Settings</div>
  <div class="settings-list">
    <div class="setting-row" id="theme-toggle-row">
      <div class="setting-icon">🌙</div>
      <div class="setting-info">
        <div class="setting-title">Dark Mode</div>
        <div class="setting-sub">Toggle light / dark theme</div>
      </div>
      <label class="toggle-sw"><input type="checkbox" id="theme-toggle" checked><div class="toggle-track"></div></label>
    </div>
    <div class="setting-row" id="notif-perm-row">
      <div class="setting-icon">🔔</div>
      <div class="setting-info">
        <div class="setting-title">Enable Notifications</div>
        <div class="setting-sub" id="notif-status">Tap to allow reminders</div>
      </div>
      <label class="toggle-sw"><input type="checkbox" id="notif-toggle"><div class="toggle-track"></div></label>
    </div>
    <div class="setting-row" id="cal-target-row">
      <div class="setting-icon">⚖️</div>
      <div class="setting-info">
        <div class="setting-title">Calorie Targets</div>
        <div class="setting-sub" id="cal-target-sub">2,200 kcal · P:140g C:240g F:60g</div>
      </div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="setting-right"><polyline points="9 18 15 12 9 6"/></svg>
    </div>
    <div class="setting-row" id="plan-phase-row">
      <div class="setting-icon">📅</div>
      <div class="setting-info">
        <div class="setting-title">Current Plan Phase</div>
        <div class="setting-sub" id="plan-phase-sub">Year 1 · Month 1–3 · Foundation</div>
      </div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="setting-right"><polyline points="9 18 15 12 9 6"/></svg>
    </div>
    <div class="setting-row" id="view-targets-row">
      <div class="setting-icon">🗺️</div>
      <div class="setting-info">
        <div class="setting-title">View Future Phase Targets</div>
        <div class="setting-sub">Browse nutrition &amp; body targets for all 8 phases</div>
      </div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="setting-right"><polyline points="9 18 15 12 9 6"/></svg>
    </div>
  </div>

  <div class="sec-lbl">2-Year Roadmap</div>
  <div id="roadmap-preview" style="margin:0 16px">
    <div class="card" style="overflow:hidden" id="roadmap-card">
      <!-- rendered by JS -->
    </div>
  </div>

  <div class="sec-lbl">Year 1 Progress</div>
  <div style="padding:0 16px">
    <div class="card card-pad">
      <div style="display:flex;justify-content:space-between;margin-bottom:10px">
        <div style="font-size:14px;font-weight:600;color:var(--text)">Weight Loss</div>
        <div style="font-size:12px;color:var(--text3)" id="prog-w-lbl">92 → 72 kg</div>
      </div>
      <div class="prog-track"><div class="prog-fill" id="prog-w" style="width:0%"></div></div>
      <div style="display:flex;justify-content:space-between;margin:14px 0 8px">
        <div style="font-size:14px;font-weight:600;color:var(--text)">Waist</div>
        <div style="font-size:12px;color:var(--text3)">38 → 30 in</div>
      </div>
      <div class="prog-track"><div class="prog-fill" id="prog-ws" style="width:0%"></div></div>
    </div>
  </div>

  <div class="sec-lbl">Current Phase Targets</div>
  <div style="padding:0 16px" id="phase-targets-card"></div>

  <div class="sec-lbl">Milestones</div>
  <div style="padding:0 16px;display:flex;flex-direction:column;gap:8px;padding-bottom:4px" id="milestones-list"></div>
  <div style="height:16px"></div>
</div>

<!-- ══════════ NAV ══════════ -->
<nav>
  <button class="nav-btn active" data-page="home">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    <span>Home</span><div class="nav-indicator"></div>
  </button>
  <button class="nav-btn" data-page="workout">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6.5 6.5h11M6.5 17.5h11M2 12h4m12 0h4"/><circle cx="6" cy="12" r="2"/><circle cx="18" cy="12" r="2"/></svg>
    <span>Workout</span><div class="nav-indicator"></div>
  </button>
  <button class="nav-btn" data-page="cal">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2a9 9 0 100 18A9 9 0 0012 2z"/><path d="M8.5 14s1.5 2 3.5 2 3.5-2 3.5-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
    <span>Calories</span><div class="nav-indicator"></div>
  </button>
  <button class="nav-btn" data-page="reports">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
    <span>Reports</span><div class="nav-indicator"></div>
  </button>
  <button class="nav-btn" data-page="profile">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
    <span>Profile</span><div class="nav-indicator"></div>
  </button>
</nav>

<!-- ══════════ OVERLAYS ══════════ -->
<div class="overlay" id="overlay"></div>

<!-- GYM TIME SHEET -->
<div class="sheet" id="gym-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">SET GYM TIME</div>
  <div class="sheet-sub">Your trainer will remind you to drink water, eat pre-workout, and warm up at the right times.</div>
  <div class="inp-group">
    <label class="inp-label">Gym Time Today</label>
    <input type="time" class="inp" id="gym-time-inp">
  </div>
  <div class="inp-group" style="padding-top:0">
    <label class="inp-label">Pre-Workout Lead Time</label>
    <select class="inp" id="preworkout-lead">
      <option value="30">30 minutes before</option>
      <option value="45" selected>45 minutes before</option>
      <option value="60">60 minutes before</option>
    </select>
  </div>
  <div class="inp-group"><button class="btn btn-primary" id="gym-time-save">SAVE GYM TIME</button></div>
</div>

<!-- FOOD ADD SHEET -->
<div class="sheet" id="food-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">ADD FOOD</div>
  <div class="inp-group">
    <label class="inp-label">Food Name</label>
    <input type="text" class="inp" id="f-name" placeholder="e.g. 4 Boiled Eggs">
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:0">
    <div class="inp-group"><label class="inp-label">Calories</label><input type="number" class="inp" id="f-kcal" placeholder="280" inputmode="numeric"></div>
    <div class="inp-group"><label class="inp-label">Protein (g)</label><input type="number" class="inp" id="f-p" placeholder="24" inputmode="numeric"></div>
    <div class="inp-group"><label class="inp-label">Carbs (g)</label><input type="number" class="inp" id="f-c" placeholder="0" inputmode="numeric"></div>
    <div class="inp-group"><label class="inp-label">Fat (g)</label><input type="number" class="inp" id="f-f" placeholder="20" inputmode="numeric"></div>
  </div>
  <div class="inp-group"><button class="btn btn-primary" id="food-save">SAVE FOOD</button></div>
</div>

<!-- BODY LOG SHEET -->
<div class="sheet" id="body-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">LOG STATS</div>
  <div class="inp-group"><label class="inp-label">Weight (kg)</label><input type="number" class="inp" id="bl-w" placeholder="92" inputmode="decimal"></div>
  <div class="inp-group"><label class="inp-label">Waist (inches)</label><input type="number" class="inp" id="bl-ws" placeholder="38" inputmode="decimal"></div>
  <div class="inp-group"><label class="inp-label">Resting HR (bpm)</label><input type="number" class="inp" id="bl-rhr" placeholder="80" inputmode="numeric"></div>
  <div class="inp-group"><label class="inp-label">Sleep (hours)</label><input type="number" class="inp" id="bl-sl" placeholder="7" inputmode="decimal"></div>
  <div class="inp-group"><button class="btn btn-primary" id="body-save">SAVE STATS</button></div>
</div>

<!-- PLAN PHASE SHEET -->
<div class="sheet" id="phase-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">CURRENT PHASE</div>
  <div class="sheet-sub">Select your current plan phase — calorie targets update automatically.</div>
  <div style="padding:0 20px 20px;display:flex;flex-direction:column;gap:8px" id="phase-options">
    <!-- rendered by JS -->
  </div>
</div>

<!-- VIEW FUTURE TARGETS SHEET -->
<div class="sheet" id="targets-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">PHASE <span style="color:var(--accent)">TARGETS</span></div>
  <div class="sheet-sub">Select any phase to preview its nutrition &amp; body targets.</div>
  <div style="padding:0 20px 10px">
    <select class="inp" id="target-phase-select">
      <!-- rendered by JS -->
    </select>
  </div>
  <div id="target-phase-preview" style="padding:0 20px 24px">
    <!-- rendered by JS -->
  </div>
</div>

<!-- CALORIE TARGET SHEET -->
<div class="sheet" id="cal-target-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">CALORIE TARGETS</div>
  <div class="sheet-sub">Choose a preset from your plan or enter custom values.</div>

  <div class="inp-group">
    <label class="inp-label">Preset (by bodyweight)</label>
    <select class="inp" id="cal-preset-select">
      <option value="">— Select Preset —</option>
      <option value="2200|140|240|60">90–92 kg · 2,200 kcal · P:140g C:240g F:60g</option>
      <option value="2100|140|228|58">85–89 kg · 2,100 kcal · P:140g C:228g F:58g</option>
      <option value="2000|140|218|55">80–84 kg · 2,000 kcal · P:140g C:218g F:55g</option>
      <option value="1900|140|205|52">75–79 kg · 1,900 kcal · P:140g C:205g F:52g</option>
      <option value="1850|140|198|50">72–74 kg · 1,850 kcal · P:140g C:198g F:50g (Y1 Target)</option>
      <option value="1950|155|200|55">Y2 Recomp · 1,950 kcal · P:155g C:200g F:55g</option>
      <option value="2050|160|212|58">Y2 Lean Gain · 2,050 kcal · P:160g C:212g F:58g</option>
      <option value="1950|160|200|55">Y2 Elite Lean · 1,950 kcal · P:160g C:200g F:55g</option>
      <option value="2000|165|205|57">Y2 Mastery · 2,000 kcal · P:165g C:205g F:57g</option>
      <option value="custom">Custom…</option>
    </select>
  </div>

  <div id="cal-custom-fields" style="display:none">
    <div class="inp-group"><label class="inp-label">Calories (kcal)</label><input type="number" class="inp" id="ct-kcal" placeholder="2200" inputmode="numeric"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:0 20px">
      <div><label class="inp-label" style="font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px">Protein (g)</label><input type="number" class="inp" id="ct-p" placeholder="140" inputmode="numeric"></div>
      <div><label class="inp-label" style="font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px">Carbs (g)</label><input type="number" class="inp" id="ct-c" placeholder="240" inputmode="numeric"></div>
      <div><label class="inp-label" style="font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px">Fat (g)</label><input type="number" class="inp" id="ct-f" placeholder="60" inputmode="numeric"></div>
    </div>
  </div>

  <div class="inp-group" style="margin-top:8px"><button class="btn btn-primary" id="cal-target-save">SAVE TARGETS</button></div>
</div>

<!-- BURN CONFIRM SHEET -->
<div class="sheet" id="burn-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Calories <span>Burned</span></div>
  <div class="sheet-sub" id="burn-sheet-sub">Based on your session type and weight, we estimate you burned:</div>
  <div style="text-align:center;padding:16px 20px">
    <div style="font-size:64px;font-weight:800;color:var(--accent);letter-spacing:-2px" id="burn-estimate">0</div>
    <div style="font-size:13px;color:var(--text3)">kcal estimated</div>
  </div>
  <div class="inp-group"><label class="inp-label">Adjust if needed</label><input type="number" class="inp" id="burn-adjust" inputmode="numeric"></div>
  <div class="inp-group"><button class="btn btn-primary" id="burn-confirm">CONFIRM BURN</button></div>
</div>

<!-- WEIGHT CALORIE SUGGESTION SHEET -->
<div class="sheet" id="weight-suggest-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">UPDATE <span style="color:var(--accent)">CALORIES?</span></div>
  <div class="sheet-sub" id="wss-sub">Based on your 7-day average weight, your targets should adjust.</div>
  <div style="margin:0 20px 16px;background:var(--card);border-radius:16px;overflow:hidden">
    <div style="padding:14px 16px;border-bottom:0.5px solid var(--border);display:flex;justify-content:space-between;align-items:center">
      <div style="font-size:13px;color:var(--text3);font-weight:500">7-day Avg Weight</div>
      <div style="font-size:17px;font-weight:700;color:var(--text)" id="wss-avg-weight">—</div>
    </div>
    <div style="padding:14px 16px;border-bottom:0.5px solid var(--border);display:flex;justify-content:space-between;align-items:center">
      <div style="font-size:13px;color:var(--text3);font-weight:500">Current Calories</div>
      <div style="font-size:17px;font-weight:700;color:var(--text3)" id="wss-cur-kcal">—</div>
    </div>
    <div style="padding:14px 16px;display:flex;justify-content:space-between;align-items:center;background:var(--accent-dim)">
      <div style="font-size:13px;color:var(--accent);font-weight:600">Suggested Calories</div>
      <div style="font-size:17px;font-weight:700;color:var(--accent)" id="wss-new-kcal">—</div>
    </div>
  </div>
  <div style="padding:0 20px;font-size:12px;color:var(--text3);line-height:1.6;margin-bottom:16px" id="wss-macro-preview"></div>
  <div class="inp-group"><button class="btn btn-primary" id="wss-apply">APPLY NEW TARGETS</button></div>
  <div class="inp-group" style="padding-top:0"><button class="btn btn-ghost" id="wss-dismiss">KEEP CURRENT</button></div>
</div>

<!-- GOOGLE FIT SHEET -->
<div class="sheet" id="gfit-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Connect <span>Google Fit</span></div>
  <div class="sheet-sub">Automatically sync your steps, heart rate, and calorie burn from Google Fit or any connected wearable.</div>
  <div style="margin:8px 20px 0;background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:hidden">
    <div style="padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px">
      <div style="font-size:20px">👟</div>
      <div>
        <div style="font-size:13px;font-weight:600;color:var(--text)">Steps → NEAT Burn</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">Auto-calculates your daily activity calories</div>
      </div>
    </div>
    <div style="padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px">
      <div style="font-size:20px">❤️</div>
      <div>
        <div style="font-size:13px;font-weight:600;color:var(--text)">Heart Rate → Real Burn</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">More accurate calorie burn using HR zones</div>
      </div>
    </div>
    <div style="padding:16px;display:flex;align-items:center;gap:12px">
      <div style="font-size:20px">⚡</div>
      <div>
        <div style="font-size:13px;font-weight:600;color:var(--text)">Auto Workout Detection</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">Logs your sessions automatically via Fit</div>
      </div>
    </div>
  </div>
  <div style="margin:16px 20px 4px;padding:14px;background:var(--amber-dim);border:1px solid rgba(255,214,10,.2);border-radius:14px">
    <div style="font-size:12px;color:var(--text2);line-height:1.6">⚠️ <strong>Note:</strong> Google Fit API requires a hosted domain (not localhost) and OAuth setup. To enable live sync, deploy this app and configure your Google Cloud credentials. For now, you can manually log burns after sessions.</div>
  </div>
  <div class="inp-group" style="margin-top:8px"><button class="btn btn-primary" onclick="closeSheets();showToast('🔗 Google Fit integration needs deployment — see note above')">CONNECT GOOGLE FIT</button></div>
  <div class="inp-group" style="padding-top:0"><button class="btn btn-ghost" onclick="closeSheets()">Not Now</button></div>
</div>

</div><!-- /app -->

<!-- ══════════ ACTIVE SESSION OVERLAY ══════════ -->
<div id="active-session">
  <div class="as-header">
    <div class="as-close" id="as-close">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </div>
    <div class="as-title-wrap">
      <div class="as-session-name" id="as-session-name">UPPER STRENGTH</div>
      <div class="as-ex-count" id="as-ex-count">Exercise 1 of 8</div>
    </div>
    <div style="font-family:'DM Mono',monospace;font-size:13px;color:var(--text3)" id="as-timer">00:00</div>
  </div>

  <div class="as-progress-row">
    <div style="flex:1" class="prog-track"><div class="prog-fill" id="as-prog-bar" style="width:0%"></div></div>
    <div style="font-size:11px;color:var(--accent);flex-shrink:0;margin-left:8px;font-weight:700;font-variant-numeric:tabular-nums" id="as-prog-val">0%</div>
  </div>

  <div class="as-body" id="as-body">
    <!-- Active exercise card rendered here -->
  </div>

  <div class="as-footer">
    <button class="btn btn-ghost" style="flex:1" id="as-prev-btn">← PREV</button>
    <button class="btn btn-primary" style="flex:2" id="as-next-btn">NEXT →</button>
  </div>
</div>

<!-- REST TIMER OVERLAY -->
<div class="rest-overlay" id="rest-overlay">
  <div class="rest-title">REST PERIOD</div>
  <div class="rest-big" id="rest-countdown">02:00</div>
  <div class="rest-next" id="rest-next-info">Next: DB Overhead Press</div>
  <button class="rest-skip" id="rest-skip">SKIP REST →</button>
</div>

<!-- SESSION COMPLETE -->
<div class="session-complete" id="session-complete">
  <div class="sc-icon">🏆</div>
  <div class="sc-title">SESSION<br>COMPLETE</div>
  <div style="font-size:13px;color:var(--text3);text-align:center">That's another brick in the wall.</div>
  <div class="sc-stats" id="sc-stats"></div>
  <button class="btn btn-primary" id="sc-done-btn">BACK TO WORKOUT</button>
</div>

<div id="toast"></div>

<script>
// ═══════════════════════════════════════════════════════════════
// DATA
// ═══════════════════════════════════════════════════════════════
const DAYS_SHORT = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

const WORKOUTS = [
  { name:'UPPER STRENGTH', meta:'Chest + Back · ~55 min', tag:'Day 1', met:5,
    exercises:[
      {n:'Smith Machine Bench Press', plan:'3→4 sets · 6–8 reps', planWeight:32.5, eq:'Smith Machine',
       tip:'Lower bar to chest, explosive drive up. Pause 1 sec on chest.',
       startWeight:32.5, increment:2.5},
      {n:'Assisted Pull-Ups', plan:'3 sets · 3–5 reps', planWeight:0, eq:'Pull-up bar',
       tip:'Dead hang start, chin clears bar. Control 3-sec negative.',
       startWeight:0, increment:0},
      {n:'Smith Bent-Over Row', plan:'3 sets · 8–10 reps', planWeight:27.5, eq:'Smith Machine',
       tip:'Flat back, pull bar to navel. Hard squeeze at top.',
       startWeight:27.5, increment:2.5},
      {n:'DB Overhead Press (seated)', plan:'3 sets · 8–10 reps', planWeight:9, eq:'Dumbbells',
       tip:'Elbows at 90°, press straight overhead. Full lockout.',
       startWeight:9, increment:1},
      {n:'Incline DB Press', plan:'3 sets · 8–10 reps', planWeight:9, eq:'DB + Bench',
       tip:'Upper chest focus. Controlled 3-sec descent.',
       startWeight:9, increment:1},
      {n:'Face Pulls', plan:'3 sets · 12–15 reps', planWeight:0, eq:'Cable',
       tip:'Elbows high, pull to forehead level. Rear delt focus.',
       startWeight:0, increment:0},
      {n:'Plank', plan:'3 sets · 25 sec (add 5 sec/week)', planWeight:0, eq:'Bodyweight',
       tip:'Straight line head to heels. Do NOT let hips sag.',
       startWeight:0, increment:0},
      {n:'Push-Up Practice', plan:'2 sets · Max reps', planWeight:0, eq:'Bodyweight',
       tip:'Slow and controlled. Track every rep — aim +1 each time.',
       startWeight:0, increment:0},
    ]},
  { name:'LOWER STRENGTH', meta:'Legs + Glutes · ~55 min', tag:'Day 2', met:6,
    exercises:[
      {n:'Smith Machine Squat', plan:'3→4 sets · 8–10 reps', planWeight:35, eq:'Smith Machine',
       tip:'Knees track over toes, break parallel. Control descent.',startWeight:35,increment:2.5},
      {n:'Leg Press', plan:'3 sets · 10–12 reps', planWeight:55, eq:'Machine',
       tip:'Full ROM. Do not lock out at top. Feet shoulder-width.',startWeight:55,increment:5},
      {n:'Smith Machine RDL', plan:'3 sets · 8–10 reps', planWeight:35, eq:'Smith Machine',
       tip:'Hinge at hips, back flat. Feel hamstring stretch at bottom.',startWeight:35,increment:2.5},
      {n:'Walking Lunges', plan:'3 sets · 10/leg', planWeight:0, eq:'Bodyweight',
       tip:'Long step, rear knee stops just before floor.',startWeight:0,increment:0},
      {n:'Leg Curl', plan:'3 sets · 10–12 reps', planWeight:0, eq:'Machine',
       tip:'Full extension, full curl. 4-sec slow negative.',startWeight:0,increment:0},
      {n:'Leg Extension', plan:'3 sets · 12–15 reps', planWeight:0, eq:'Machine',
       tip:'Squeeze hard at top. Slow descent.',startWeight:0,increment:0},
      {n:'Standing Calf Raises', plan:'3 sets · 20–25 reps', planWeight:0, eq:'BW / Machine',
       tip:'Heel fully below platform. Full stretch at bottom.',startWeight:0,increment:0},
      {n:'Hanging Knee Raises', plan:'3 sets · 10–12 reps', planWeight:0, eq:'Pull-up bar',
       tip:'Pull knees to chest. Control the descent.',startWeight:0,increment:0},
    ]},
  { name:'CARDIO + CORE', meta:'Fat Burn · ~50 min', tag:'Day 3', met:5,
    exercises:[
      {n:'Brisk Walk / Jog', plan:'20–30 min · Zone 2 · HR 119–139', planWeight:0, eq:'Outdoor',
       tip:'If you cannot speak a full sentence, you are going too fast. Slow down.',startWeight:0,increment:0},
      {n:'Plank', plan:'3 sets · 25–30 sec', planWeight:0, eq:'Bodyweight',
       tip:'Add 5 sec per week. Target 60 sec by Week 6.',startWeight:0,increment:0},
      {n:'Leg Raises', plan:'3 sets · 10–12 reps', planWeight:0, eq:'Bodyweight',
       tip:'Slow and controlled. Lower abs.',startWeight:0,increment:0},
      {n:'Russian Twists', plan:'3 sets · 20 reps', planWeight:0, eq:'Bodyweight',
       tip:'Bodyweight first. Add light plate from Week 5.',startWeight:0,increment:0},
      {n:'Dead Bug', plan:'3 sets · 8/side', planWeight:0, eq:'Bodyweight',
       tip:'Press lower back into floor the entire time.',startWeight:0,increment:0},
      {n:'Cable Woodchops', plan:'3 sets · 10/side', planWeight:0, eq:'Cable',
       tip:'Rotational core. Functional strength.',startWeight:0,increment:0},
      {n:'Mountain Climbers', plan:'2 sets · 25 sec', planWeight:0, eq:'Bodyweight',
       tip:'If HR > 155 bpm stop and rest before continuing.',startWeight:0,increment:0},
      {n:'Hollow Body Hold', plan:'2 sets · 20 sec', planWeight:0, eq:'Bodyweight',
       tip:'Lower back stays on floor the whole time.',startWeight:0,increment:0},
    ]},
  { name:'UPPER HYPERTROPHY', meta:'Volume + Arms · ~55 min', tag:'Day 4', met:5,
    exercises:[
      {n:'Incline DB Press', plan:'4 sets · 10–12 reps', planWeight:9, eq:'DB + Bench',
       tip:'Upper chest. 60–90 sec rest strictly.',startWeight:9,increment:1},
      {n:'Seated Cable Row', plan:'4 sets · 10–12 reps', planWeight:0, eq:'Cable',
       tip:'Hard squeeze at full contraction. Hold 1 sec.',startWeight:0,increment:0},
      {n:'Lat Pulldown', plan:'3 sets · 10–12 reps', planWeight:0, eq:'Cable',
       tip:'Wide lats = V-taper. Pull bar to upper chest.',startWeight:0,increment:0},
      {n:'Cable Fly / Pec Deck', plan:'3 sets · 12–15 reps', planWeight:0, eq:'Cable',
       tip:'2-sec squeeze at peak contraction every rep.',startWeight:0,increment:0},
      {n:'DB Bicep Curls', plan:'3 sets · 10–12 reps', planWeight:8, eq:'Dumbbells',
       tip:'3-sec slow negative. No swinging.',startWeight:8,increment:1},
      {n:'Rope Pushdowns', plan:'3 sets · 10–12 reps', planWeight:0, eq:'Cable',
       tip:'Full extension at bottom. Elbows pinned at sides.',startWeight:0,increment:0},
      {n:'Hammer Curls', plan:'2 sets · 12 reps', planWeight:8, eq:'Dumbbells',
       tip:'Brachialis. Adds arm thickness.',startWeight:8,increment:1},
      {n:'Rear Delt Cable Fly', plan:'3 sets · 12–15 reps', planWeight:0, eq:'Cable',
       tip:'Elbows wide. Pull back and apart.',startWeight:0,increment:0},
      {n:'Plank + Shoulder Taps', plan:'3 sets · 20 taps', planWeight:0, eq:'Bodyweight',
       tip:'Hips must stay perfectly square.',startWeight:0,increment:0},
    ]},
  { name:'LOWER + CARDIO', meta:'RDL Focus · ~55 min', tag:'Day 5', met:6,
    exercises:[
      {n:'Smith Machine RDL (Heavy)', plan:'4 sets · 6–8 reps', planWeight:40, eq:'Smith Machine',
       tip:'Primary strength lift. Add weight weekly.',startWeight:40,increment:2.5},
      {n:'Bulgarian Split Squat', plan:'3 sets · 8/leg', planWeight:0, eq:'BW / DB',
       tip:'Rear foot elevated. Deep front lunge.',startWeight:0,increment:0},
      {n:'Leg Press', plan:'3 sets · 12–15 reps', planWeight:65, eq:'Machine',
       tip:'Higher reps for pump and definition.',startWeight:65,increment:5},
      {n:'Hip Thrust', plan:'3 sets · 12 reps', planWeight:0, eq:'BW / Smith',
       tip:'Glute squeeze at top. Hold 1 full second.',startWeight:0,increment:0},
      {n:'Leg Extension', plan:'3 sets · 15 reps', planWeight:0, eq:'Machine',
       tip:'Slow and controlled.',startWeight:0,increment:0},
      {n:'Seated Calf Raise', plan:'3 sets · 20 reps', planWeight:0, eq:'Machine',
       tip:'Slow full range. Calves love volume.',startWeight:0,increment:0},
      {n:'Brisk Walk / Easy Jog', plan:'15 min finisher · Zone 2', planWeight:0, eq:'Outdoor',
       tip:'Fat burn on glycogen-depleted legs. Zone 2 only.',startWeight:0,increment:0},
    ]},
  { name:'SHOULDERS + ARMS', meta:'V-Taper Day · ~50 min', tag:'Day 6', met:5,
    exercises:[
      {n:'DB Shoulder Press (seated)', plan:'4 sets · 8–10 reps', planWeight:11, eq:'Dumbbells',
       tip:'Full ROM and control. You know this lift.',startWeight:11,increment:1},
      {n:'Lateral Raises (DB)', plan:'4 sets · 12–15 reps', planWeight:5, eq:'Dumbbells',
       tip:'SLOW: 2s up · 2s hold · 3s down. If not felt in side delt — reduce weight.',startWeight:5,increment:0.5},
      {n:'Cable Lateral Raises', plan:'3 sets · 15 reps', planWeight:0, eq:'Cable',
       tip:'Better bottom tension than DB. V-taper builder.',startWeight:0,increment:0},
      {n:'Rear Delt Cable Fly', plan:'3 sets · 12–15 reps', planWeight:0, eq:'Cable',
       tip:'3D shoulder shape. Light weight, controlled.',startWeight:0,increment:0},
      {n:'Smith Machine OHP (standing)', plan:'3 sets · 8–10 reps', planWeight:22.5, eq:'Smith Machine',
       tip:'Push for strength progression each session.',startWeight:22.5,increment:2.5},
      {n:'EZ Bar / DB Curl', plan:'3 sets · 8–10 reps', planWeight:11, eq:'Dumbbells',
       tip:'Full ROM. No swinging at top.',startWeight:11,increment:1},
      {n:'Incline DB Curl', plan:'3 sets · 10–12 reps', planWeight:7, eq:'DB + Bench',
       tip:'Stretch at bottom = fuller bicep shape.',startWeight:7,increment:0.5},
      {n:'Overhead Tricep Extension', plan:'3 sets · 10–12 reps', planWeight:0, eq:'Cable / DB',
       tip:'Long head. Arms look bigger from all angles.',startWeight:0,increment:0},
      {n:'Tricep Bench Dips', plan:'3 sets · 12–15 reps', planWeight:0, eq:'Bench',
       tip:'Elbows close to body throughout.',startWeight:0,increment:0},
    ]},
  { name:'REST DAY', meta:'Full Recovery · Light walk optional', tag:'Rest', met:1.5,
    exercises:[
      {n:'Light Home Walk', plan:'20 min optional · Zone 1',planWeight:0,eq:'Outdoor',tip:'Enjoy it.',startWeight:0,increment:0},
      {n:'Stretching', plan:'Hip flexors, hamstrings, shoulders',planWeight:0,eq:'Home',tip:'Hold each 30+ sec.',startWeight:0,increment:0},
      {n:'10:15 PM Alarm', plan:'Set tonight — protect sleep',planWeight:0,eq:'Phone',tip:'Sleep is training.',startWeight:0,increment:0},
    ]},
];

const QUICK_FOODS = [
  {name:'4 Boiled Eggs',icon:'🥚',kcal:280,p:24,c:0,f:20},
  {name:'Dal (1 bowl)',icon:'🍲',kcal:150,p:9,c:25,f:2},
  {name:'Rice (1 cup)',icon:'🍚',kcal:200,p:4,c:44,f:0},
  {name:'Chicken (100g)',icon:'🍗',kcal:165,p:31,c:0,f:4},
  {name:'Paneer (100g)',icon:'🧀',kcal:265,p:18,c:3,f:20},
  {name:'Sattu (30g)',icon:'💪',kcal:120,p:11,c:16,f:2},
  {name:'Banana',icon:'🍌',kcal:90,p:1,c:23,f:0},
  {name:'Milk (250ml)',icon:'🥛',kcal:150,p:8,c:12,f:8},
  {name:'Roti (1)',icon:'🫓',kcal:100,p:3,c:20,f:1},
  {name:'Soy Chunks (50g)',icon:'🌱',kcal:175,p:25,c:12,f:1},
];

const QUOTES = [
  "72 kg. 30-inch waist. 10K in 30 minutes. It's already decided. Earn it today.",
  "The gym is 1 km away. That walk is already your cardio.",
  "Sleep is training. 10:15 pm. Wind down. Non-negotiable.",
  "Zone 2 check: can you say a full sentence? No? Slow down.",
  "Never miss twice. One is life. Two is a warning. Three is a dropout.",
  "Your only competition is yesterday's version of you.",
  "Slow is smooth. Smooth is fast. Trust the process.",
  "Muscle is built during sleep. Every hour before midnight is double.",
  "Drink your water. Pale yellow urine — that's the check.",
  "Dal, eggs, and a Smith machine. That's all you need.",
  "Discipline is the bridge between goals and accomplishment.",
  "The body achieves what the mind believes.",
  "Every rep, every set, every meal. It all adds up.",
];

// ═══════════════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════════════
function today(){return new Date().toISOString().slice(0,10)}
function load(){try{return JSON.parse(localStorage.getItem('lj2')||'{}')}catch{return{}}}
function save(){localStorage.setItem('lj2',JSON.stringify(S))}

let S = load();
// Defaults
['streak','pushups'].forEach(k=>{if(!S[k])S[k]=0});
['streakLast','gymTime','theme'].forEach(k=>{if(S[k]===undefined)S[k]=''});
if(!S.theme)S.theme='dark';
if(!S.bodyLogs)S.bodyLogs=[];
if(!S.calLog)S.calLog={};
if(!S.workoutLog)S.workoutLog={};
if(!S.burnLog)S.burnLog={};
if(!S.waterLog)S.waterLog={};
if(!S.preworkoutLead)S.preworkoutLead=45;
if(!S.calTarget)S.calTarget={kcal:2200,p:140,c:240,f:60};
if(!S.exercisePR)S.exercisePR={};

// ═══════════════════════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════════════════════
let currentPage='home';
let activeDayIdx=new Date().getDay();

function todayWater(){return S.waterLog[today()]||0}
function todayCalLog(){return S.calLog[today()]||[]}
function todayBurn(){return S.burnLog[today()]||0}
function todayTotals(){
  return todayCalLog().reduce((a,f)=>{a.kcal+=f.kcal||0;a.p+=f.p||0;a.c+=f.c||0;a.f+=f.f||0;return a},{kcal:0,p:0,c:0,f:0});
}

function showToast(msg,dur=2500){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur);
}

const overlay=document.getElementById('overlay');
overlay.addEventListener('click',closeSheets);

function openSheet(id){
  document.getElementById(id).classList.add('open');
  overlay.classList.add('open');
}
function closeSheets(){
  document.querySelectorAll('.sheet').forEach(s=>s.classList.remove('open'));
  overlay.classList.remove('open');
}

// Theme
function applyTheme(t){
  document.documentElement.setAttribute('data-theme',t);
  S.theme=t;save();
  document.getElementById('theme-meta').content=t==='dark'?'#0a0a0a':'#f4f4f0';
  document.getElementById('theme-toggle').checked=t==='dark';
}
applyTheme(S.theme||'dark');

document.getElementById('theme-toggle').addEventListener('change',function(){
  applyTheme(this.checked?'dark':'light');
});

// ═══════════════════════════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════════════════════════
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const pg=btn.dataset.page;
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('page-'+pg).classList.add('active');
    currentPage=pg;
    if(pg==='home')renderHome();
    if(pg==='workout')renderWorkout();
    if(pg==='cal')renderCalories();
    if(pg==='reports')renderReports('week');
    if(pg==='profile')renderProfile();
  });
});

// ═══════════════════════════════════════════════════════════════
// HOME
// ═══════════════════════════════════════════════════════════════
function renderHome(){
  const now=new Date();
  document.getElementById('hero-date').textContent=now.toLocaleDateString('en-US',{weekday:'long',day:'numeric',month:'long'});
  const h=now.getHours();
  document.getElementById('hero-word').textContent=h<12?'RISE.':h<17?'GRIND.':'BUILD.';
  const q=QUOTES[now.getDate()%QUOTES.length];
  document.getElementById('hero-quote').textContent='"'+q+'"';

  // Stats
  const last=S.bodyLogs[S.bodyLogs.length-1];
  document.getElementById('h-weight').innerHTML=(last?last.weight:'—')+'<em>kg</em>';
  document.getElementById('h-streak').innerHTML=S.streak+'<em>d</em>';
  const tot=todayTotals();
  document.getElementById('h-cal').innerHTML=(tot.kcal||'—')+'<em>c</em>';

  // TDEE card
  const bmr=calcBMR();
  const neat=calcNEAT();
  const burn=todayBurn();
  const tdee=bmr+neat+burn;
  const tgt=S.calTarget||{kcal:2200};
  const net=Math.max(0,tgt.kcal+burn-tot.kcal);
  document.getElementById('tdee-net').textContent=net;
  document.getElementById('tdee-total').textContent=tdee;
  document.getElementById('tdee-bmr').textContent=bmr;
  document.getElementById('tdee-neat').textContent='~'+neat;
  document.getElementById('tdee-workout-kcal').textContent=burn;
  document.getElementById('tdee-eaten').textContent=tot.kcal||0;
  const tdeeSubEl=document.getElementById('tdee-sub');
  if(net>300)tdeeSubEl.textContent='Room for more food today';
  else if(net>0)tdeeSubEl.textContent='Close to your limit — stay disciplined';
  else tdeeSubEl.textContent='Over target — skip the evening snack';

  // Google Fit health tiles (simulated until OAuth connected)
  renderFitTiles();

  // Streak
  document.getElementById('streak-big').textContent=S.streak;
  const dotsEl=document.getElementById('streak-dots');
  dotsEl.innerHTML='';
  for(let i=0;i<7;i++){
    const d=document.createElement('div');
    d.className='streak-dot'+(i<S.streak%7?' on':'');
    dotsEl.appendChild(d);
  }

  // Gym time
  renderGymTime();

  // Water
  renderWater();

  // Notifications
  scheduleChecks();
}

function renderGymTime(){
  const gt=S.gymTime;
  const disp=document.getElementById('gym-time-display');
  const info=document.getElementById('preworkout-info');
  const countdown=document.getElementById('gym-countdown');

  if(!gt){disp.textContent='Not Set';info.textContent='';countdown.textContent='—';return;}

  const [h,m]=gt.split(':').map(Number);
  const now=new Date();
  const gymDate=new Date(now);gymDate.setHours(h,m,0,0);
  const lead=S.preworkoutLead||45;
  const preDate=new Date(gymDate.getTime()-lead*60000);

  const fmt=d=>{
    let hrs=d.getHours(),mins=d.getMinutes();
    const ampm=hrs>=12?'PM':'AM';hrs=hrs%12||12;
    return `${hrs}:${String(mins).padStart(2,'0')} ${ampm}`;
  };
  disp.textContent=fmt(gymDate);
  info.textContent=`Pre-workout at ${fmt(preDate)}`;

  const diffMs=gymDate-now;
  if(diffMs>0){
    const dh=Math.floor(diffMs/3600000);
    const dm=Math.floor((diffMs%3600000)/60000);
    countdown.textContent=dh>0?`${dh}h ${dm}m`:`${dm} min`;
  }else{
    countdown.textContent='GYM TIME!';
    countdown.style.color='var(--accent)';
  }
}

function renderFitTiles(){
  // Simulated Google Fit data — replaced by real API data when connected
  const fitData=S.fitData||{steps:0,hr:0,sleep:0,heartPts:0};
  const connected=S.fitConnected||false;

  // Steps
  const stepsEl=document.getElementById('fit-steps');
  const stepsVal=connected?fitData.steps:0;
  stepsEl.innerHTML=stepsVal.toLocaleString()+'<span class="health-tile-unit"></span>';
  document.getElementById('fit-steps-sub').textContent=connected?`Goal: 10,000 steps`:'Connect Google Fit';
  document.getElementById('fit-steps-bar').style.width=Math.min(100,stepsVal/10000*100)+'%';

  // Heart Rate
  const hrEl=document.getElementById('fit-hr');
  const hrVal=connected?fitData.hr:0;
  hrEl.innerHTML=(hrVal||'—')+'<span class="health-tile-unit">bpm</span>';
  document.getElementById('fit-hr-sub').textContent=connected?'Resting heart rate':'Connect Google Fit';
  document.getElementById('fit-hr-bar').style.width=connected?Math.min(100,(hrVal/100)*100)+'%':'0%';

  // Sleep
  const sleepEl=document.getElementById('fit-sleep');
  const sleepVal=connected?fitData.sleep:0;
  sleepEl.innerHTML=(sleepVal||'—')+'<span class="health-tile-unit">h</span>';
  document.getElementById('fit-sleep-sub').textContent=connected?`Goal: 8 hours`:'Connect Google Fit';
  document.getElementById('fit-sleep-bar').style.width=connected?Math.min(100,sleepVal/8*100)+'%':'0%';

  // Heart Points
  const ptsEl=document.getElementById('fit-pts');
  const ptsVal=connected?fitData.heartPts:0;
  ptsEl.innerHTML=(ptsVal||'—')+'<span class="health-tile-unit">pts</span>';
  document.getElementById('fit-pts-sub').textContent=connected?'Weekly goal: 150 pts':'Connect Google Fit';
  document.getElementById('fit-pts-bar').style.width=connected?Math.min(100,ptsVal/150*100)+'%':'0%';
}
function renderWater(){
  const count=todayWater();
  document.getElementById('water-ml').textContent=(count*.5).toFixed(1)+'L';
  const el=document.getElementById('water-cups');
  el.innerHTML='';
  for(let i=0;i<7;i++){
    const c=document.createElement('div');
    c.className='wcup'+(i<count?' filled':'');
    c.addEventListener('click',()=>{
      const cur=S.waterLog[today()]||0;
      S.waterLog[today()]=i<cur?i:i+1;
      save();renderWater();
      document.getElementById('water-ml').textContent=((S.waterLog[today()]||0)*.5).toFixed(1)+'L';
      if((S.waterLog[today()]||0)>=7)showToast('💧 Hydration goal hit!');
    });
    el.appendChild(c);
  }
}

// Google Fit connect
document.getElementById('gfit-connect-btn').addEventListener('click',()=>openSheet('gfit-sheet'));

// ═══════════════════════════════════════════════════════════════
// GYM TIME
// ═══════════════════════════════════════════════════════════════
document.getElementById('set-gym-time-btn').addEventListener('click',()=>openSheet('gym-sheet'));

document.getElementById('gym-time-save').addEventListener('click',()=>{
  const t=document.getElementById('gym-time-inp').value;
  const lead=parseInt(document.getElementById('preworkout-lead').value);
  if(!t){showToast('Please select a time');return;}
  S.gymTime=t; S.preworkoutLead=lead; save();
  closeSheets(); renderGymTime();
  showToast('✅ Gym time set! Reminders scheduled.');
  scheduleChecks();
});

// ═══════════════════════════════════════════════════════════════
// NOTIFICATIONS
// ═══════════════════════════════════════════════════════════════
let notifGranted=false;
let notifCheckInterval=null;

document.getElementById('notif-toggle').addEventListener('change',async function(){
  if(this.checked){
    const perm=await Notification.requestPermission();
    if(perm==='granted'){
      notifGranted=true;
      S.notifEnabled=true;save();
      document.getElementById('notif-status').textContent='Reminders active ✓';
      showToast('🔔 Notifications enabled!');
    }else{
      this.checked=false;
      showToast('Please allow notifications in browser settings');
    }
  }else{
    notifGranted=false;S.notifEnabled=false;save();
  }
});

// Init notif state
if(S.notifEnabled && Notification.permission==='granted'){
  notifGranted=true;
  document.getElementById('notif-toggle').checked=true;
  document.getElementById('notif-status').textContent='Reminders active ✓';
}

function sendNotif(title,body){
  if(notifGranted&&Notification.permission==='granted'){
    new Notification(title,{body,icon:'icon-192.png',badge:'icon-192.png'});
  }
  // Also show in-app banner
  document.getElementById('notif-title').textContent=title;
  document.getElementById('notif-sub').textContent=body;
  document.getElementById('notif-banner').style.display='flex';
  setTimeout(()=>document.getElementById('notif-banner').style.display='none',8000);
}

let lastNotifKey='';
function scheduleChecks(){
  if(notifCheckInterval)clearInterval(notifCheckInterval);
  notifCheckInterval=setInterval(checkReminders,30000);
  checkReminders();
}

function checkReminders(){
  if(!S.gymTime)return;
  const now=new Date();
  const [h,m]=S.gymTime.split(':').map(Number);
  const gymDate=new Date(now);gymDate.setHours(h,m,0,0);
  const lead=S.preworkoutLead||45;
  const preDate=new Date(gymDate.getTime()-lead*60000);
  const waterReminderMins=[9*60,11*60,13*60,15*60,17*60,19*60,21*60];
  const nowMins=now.getHours()*60+now.getMinutes();

  // Pre-workout reminder
  const preMin=preDate.getHours()*60+preDate.getMinutes();
  const gymMin=gymDate.getHours()*60+gymDate.getMinutes();
  const key=`preworkout-${today()}`;
  if(Math.abs(nowMins-preMin)<=1&&lastNotifKey!==key){
    lastNotifKey=key;
    sendNotif('⚡ Pre-Workout Time!',`Take your pre-workout now. Gym starts in ${lead} minutes!`);
  }

  // Gym time reminder
  const gymKey=`gym-${today()}`;
  if(Math.abs(nowMins-gymMin)<=1&&lastNotifKey!==gymKey){
    lastNotifKey=gymKey;
    sendNotif('🏋️ GYM TIME!','Your session starts now. Walk to the gym — that\'s already your cardio.');
  }

  // Water reminders
  waterReminderMins.forEach(wm=>{
    const wkey=`water-${today()}-${wm}`;
    if(Math.abs(nowMins-wm)<=1&&lastNotifKey!==wkey){
      lastNotifKey=wkey;
      const cups=todayWater();
      if(cups<7){
        sendNotif('💧 Drink Water',`You've had ${(cups*.5).toFixed(1)}L. Target: 3.5L. Drink a cup now.`);
      }
    }
  });

  // Morning motivation
  const mkey=`morning-${today()}`;
  if(nowMins>=8*60&&nowMins<=8*60+1&&lastNotifKey!==mkey){
    lastNotifKey=mkey;
    sendNotif('🌅 Good Morning','Today is another step toward 72 kg. Drink 500ml water now.');
  }
}
scheduleChecks();

// ═══════════════════════════════════════════════════════════════
// WORKOUT PAGE
// ═══════════════════════════════════════════════════════════════
// Helper: is this exercise a cardio/mobility/non-weight exercise?
function isCardioEx(ex){
  const cardioKeywords=['walk','run','jog','stretch','alarm','zone','cardio','sleep','phone'];
  const name=(ex.n||'').toLowerCase();
  const plan=(ex.plan||'').toLowerCase();
  const eq=(ex.eq||'').toLowerCase();
  return cardioKeywords.some(k=>name.includes(k)||plan.includes(k))||
    (eq==='outdoor'&&ex.planWeight===0&&!name.includes('press')&&!name.includes('curl'))||
    (eq==='phone'||eq==='home'&&ex.planWeight===0&&name.includes('alarm'));
}

function renderWorkout(){
  const nav=document.getElementById('day-scroll');
  const now=new Date();
  nav.innerHTML='';

  // Update today label in header
  const todayEl=document.getElementById('workout-today-lbl');
  if(todayEl){
    todayEl.textContent=now.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  }

  for(let i=0;i<7;i++){
    const d=new Date(now);
    d.setDate(now.getDate()-now.getDay()+i);
    const ds=d.toISOString().slice(0,10);
    const isToday=i===now.getDay();
    const chip=document.createElement('div');
    chip.className='day-chip'
      +(i===activeDayIdx?' selected':'')
      +(isToday?' today':'')
      +(S.workoutLog[ds]?' logged':'');
    chip.innerHTML=`<div class="d-name">${DAYS_SHORT[i]}</div>
      <div class="d-num">${d.getDate()}</div>
      <div class="d-done-dot"></div>`;
    chip.addEventListener('click',()=>{activeDayIdx=i;renderWorkout();});
    nav.appendChild(chip);
  }

  const w=WORKOUTS[activeDayIdx];
  const isToday2=activeDayIdx===now.getDay();
  document.getElementById('workout-day-lbl').textContent=DAYS_SHORT[activeDayIdx].toUpperCase()+' — '+w.name+(isToday2?' · TODAY':'');
  document.getElementById('sesh-name').textContent=w.name;
  document.getElementById('sesh-meta').textContent=w.meta;
  document.getElementById('sesh-tag').textContent=w.tag;

  // Progress
  const selDate=new Date(now);selDate.setDate(now.getDate()-now.getDay()+activeDayIdx);
  const ds=selDate.toISOString().slice(0,10);
  const wlog=S.workoutLog[ds]||{};
  const done=w.exercises.filter((_,i)=>wlog[i]&&wlog[i].sets&&wlog[i].sets.length>0).length;
  const pct=w.exercises.length>0?done/w.exercises.length*100:0;
  document.getElementById('sesh-prog-bar').style.width=pct+'%';
  document.getElementById('sesh-prog-val').textContent=done+'/'+w.exercises.length;

  // Exercise list
  const list=document.getElementById('ex-list');
  list.innerHTML='';
  w.exercises.forEach((ex,i)=>{
    const logged=wlog[i]||{};
    const sets=logged.sets||[];
    const isDone=sets.length>0;
    const isCardio=isCardioEx(ex);
    const card=document.createElement('div');
    card.className='ex-card'+(isDone?' done-ex':'');
    card.dataset.idx=i;

    // Weight suggestion
    const pr=S.exercisePR[ex.n];
    let suggestText='';
    if(isCardio){
      suggestText=`${ex.tip} — Log duration when done.`;
    }else if(pr&&pr.weight>0){
      const nextW=pr.weight+(ex.increment||0);
      suggestText=`Last: ${pr.weight}kg × ${pr.reps} reps. Try <strong>${nextW}kg</strong> today (+${ex.increment}kg overload).`;
    }else if(ex.startWeight>0){
      suggestText=`Start with <strong>${ex.startWeight}kg</strong>. Calibrated for your level.`;
    }else{
      suggestText=`${ex.tip}`;
    }

    // Smart inputs: cardio/mobility = duration + notes, strength = weight/reps/rest
    const loggedRows=sets.map((s,si)=>`<div class="set-row-logged">
      <span class="set-row-lbl">${isCardio?'Log':'Set'} ${si+1}</span>
      <span class="set-row-vals">${isCardio?(s.duration||s.reps)+' min':(s.weight>0?s.weight+'kg · ':'')+s.reps+' reps · '+s.rest+'s rest'}</span>
      <span class="set-row-del" data-exidx="${i}" data-sidx="${si}">×</span>
    </div>`).join('');

    const inputsHTML=isCardio?`
      <div class="set-inputs-row" style="grid-template-columns:1fr 1fr">
        <div class="set-inp-wrap">
          <div class="set-inp-lbl" style="color:var(--blue)">Duration (min)</div>
          <input class="set-inp duration" type="number" id="sinp-r-${i}" placeholder="20" inputmode="numeric">
        </div>
        <div class="set-inp-wrap">
          <div class="set-inp-lbl">Effort (1–10)</div>
          <input class="set-inp" type="number" id="sinp-rest-${i}" placeholder="5" inputmode="numeric" min="1" max="10">
        </div>
      </div>
      <input type="hidden" id="sinp-w-${i}" value="0">`
    :`<div class="set-inputs-row">
        <div class="set-inp-wrap">
          <div class="set-inp-lbl">Weight (kg)</div>
          <input class="set-inp" type="number" id="sinp-w-${i}" placeholder="${ex.startWeight||0}" inputmode="decimal">
        </div>
        <div class="set-inp-wrap">
          <div class="set-inp-lbl">Reps</div>
          <input class="set-inp" type="number" id="sinp-r-${i}" placeholder="8" inputmode="numeric">
        </div>
        <div class="set-inp-wrap">
          <div class="set-inp-lbl">Rest (sec)</div>
          <input class="set-inp" type="number" id="sinp-rest-${i}" placeholder="120" inputmode="numeric">
        </div>
      </div>`;

    card.innerHTML=`
      <div class="ex-header">
        <div class="ex-num-badge${isDone?" done":""}">${isDone?"✓":(i+1)}</div>
        <div class="ex-name-wrap">
          <div class="ex-name">${ex.n}</div>
          <div class="ex-plan">${ex.plan} · <span style="color:${isCardio?'var(--blue)':'var(--text3)'}">${ex.eq}</span></div>
        </div>
        <svg class="ex-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="set-logger">
        <div class="suggest-box">
          <div class="suggest-title">${isCardio?'⏱ Activity':'🤖 Coach Says'}</div>
          <div class="suggest-txt">${suggestText}</div>
        </div>
        <div class="sets-logged" id="sets-logged-${i}">${loggedRows}</div>
        ${inputsHTML}
        <div class="set-btn-row">
          <button class="log-set-btn" data-idx="${i}">+ ${isCardio?'LOG ACTIVITY':'LOG SET '+(sets.length+1)}</button>
          ${isDone?`<button class="done-ex-btn" data-idx="${i}">✓ DONE</button>`:''}
        </div>
      </div>`;

    // Toggle expand
    card.querySelector('.ex-header').addEventListener('click',()=>{
      const wasExpanded=card.classList.contains('expanded');
      document.querySelectorAll('.ex-card').forEach(c=>c.classList.remove('expanded'));
      if(!wasExpanded)card.classList.add('expanded');
    });

    // Log set button
    card.querySelector('.log-set-btn').addEventListener('click',e=>{
      e.stopPropagation();
      const idx=parseInt(e.currentTarget.dataset.idx);
      logSet(idx,ds);
    });

    // Delete set
    card.querySelectorAll('.set-row-del').forEach(btn=>{
      btn.addEventListener('click',e=>{
        e.stopPropagation();
        const ei=parseInt(btn.dataset.exidx);
        const si=parseInt(btn.dataset.sidx);
        if(S.workoutLog[ds]&&S.workoutLog[ds][ei]){
          S.workoutLog[ds][ei].sets.splice(si,1);
          save();renderWorkout();
        }
      });
    });

    list.appendChild(card);
  });
}

function logSet(exIdx,ds){
  const ex=WORKOUTS[activeDayIdx].exercises[exIdx];
  const w=parseFloat(document.getElementById(`sinp-w-${exIdx}`).value)||ex.startWeight||0;
  const r=parseInt(document.getElementById(`sinp-r-${exIdx}`).value)||8;
  const rest=parseInt(document.getElementById(`sinp-rest-${exIdx}`).value)||120;

  if(!S.workoutLog[ds])S.workoutLog[ds]={};
  if(!S.workoutLog[ds][exIdx])S.workoutLog[ds][exIdx]={sets:[]};
  S.workoutLog[ds][exIdx].sets.push({weight:w,reps:r,rest});

  // Update PR
  if(!S.exercisePR[ex.n]||w>S.exercisePR[ex.n].weight||(w===S.exercisePR[ex.n].weight&&r>S.exercisePR[ex.n].reps)){
    S.exercisePR[ex.n]={weight:w,reps:r,date:ds};
  }

  // Update streak
  if(S.streakLast!==today()){
    const yesterday=new Date();yesterday.setDate(yesterday.getDate()-1);
    const yd=yesterday.toISOString().slice(0,10);
    S.streak=(S.streakLast===yd||!S.streakLast)?S.streak+1:1;
    S.streakLast=today();
  }
  save();

  showToast(`✅ Set logged — ${w>0?w+'kg · ':''}${r} reps`);
  renderWorkout();
  renderHome();
}

// START SESSION BUTTON — Active session mode
document.getElementById('start-session-btn').addEventListener('click',()=>startActiveSession());

// ═══════════════════════════════════════════════════════════════
// ACTIVE SESSION
// ═══════════════════════════════════════════════════════════════
let asCurrentEx=0;
let asSessionStart=null;
let asTimerInterval=null;
let restTimerInterval=null;
let asRestTarget=0;
let asRestRemaining=0;

function startActiveSession(){
  const w=WORKOUTS[activeDayIdx];
  if(w.tag==='Rest'){showToast('Rest day! Walk, stretch, and sleep.');return;}
  asCurrentEx=0;asSessionStart=Date.now();
  document.getElementById('as-session-name').textContent=w.name;
  document.getElementById('active-session').classList.add('open');
  // Session timer
  if(asTimerInterval)clearInterval(asTimerInterval);
  asTimerInterval=setInterval(()=>{
    const elapsed=Math.floor((Date.now()-asSessionStart)/1000);
    const mm=String(Math.floor(elapsed/60)).padStart(2,'0');
    const ss=String(elapsed%60).padStart(2,'0');
    document.getElementById('as-timer').textContent=mm+':'+ss;
  },1000);
  renderActiveEx();
}

function renderActiveEx(){
  const w=WORKOUTS[activeDayIdx];
  const ex=w.exercises[asCurrentEx];
  const pct=Math.round(asCurrentEx/w.exercises.length*100);

  document.getElementById('as-ex-count').textContent=`Exercise ${asCurrentEx+1} of ${w.exercises.length}`;
  document.getElementById('as-prog-bar').style.width=pct+'%';
  document.getElementById('as-prog-val').textContent=pct+'%';

  const ds=new Date().toISOString().slice(0,10);
  const exLog=S.workoutLog[ds]?.[asCurrentEx]||{sets:[]};
  const sets=exLog.sets||[];

  const pr=S.exercisePR[ex.n];
  let suggestHTML='';
  if(pr&&pr.weight>0){
    const nw=(pr.weight+(ex.increment||0));
    suggestHTML=`Last time: <strong>${pr.weight}kg × ${pr.reps} reps</strong>.<br>Try <strong style="color:var(--accent)">${nw}kg</strong> today for progressive overload.`;
  }else if(ex.startWeight>0){
    suggestHTML=`Recommended starting weight: <strong style="color:var(--accent)">${ex.startWeight}kg</strong>`;
  }else{
    suggestHTML=`Bodyweight / machine. Focus on form.`;
  }

  const setsHTML=sets.map((s,i)=>`
    <div class="aex-set-logged">
      <div class="aex-set-lbl">Set ${i+1}</div>
      <div class="aex-set-vals">${s.weight>0?s.weight+'kg · ':''}${s.reps} reps · ${s.rest}s rest</div>
      <div class="aex-set-del" data-si="${i}">×</div>
    </div>`).join('');

  const body=document.getElementById('as-body');
  body.innerHTML=`
    <div class="aex-card scale-in">
      <div class="aex-hdr">
        <div class="aex-num">Exercise ${asCurrentEx+1} of ${w.exercises.length}</div>
        <div class="aex-name">${ex.n}</div>
        <div class="aex-plan-detail">${ex.plan} · ${ex.eq}</div>
      </div>
      <div class="aex-suggest">
        <div class="aex-suggest-title">🤖 Coach Says</div>
        <div class="aex-suggest-body">${suggestHTML}<br><span style="color:var(--text3);font-style:italic">${ex.tip}</span></div>
      </div>
      ${sets.length>0?`<div class="aex-sets-done" id="aex-sets-done">${setsHTML}</div>`:''}
      <div class="aex-set-area">
        <div class="aex-set-title">Log Set ${sets.length+1}</div>
        <div class="aex-inputs">
          <div class="aex-inp-wrap"><div class="aex-inp-lbl">Weight (kg)</div>
            <input class="aex-inp" type="number" id="aex-w" placeholder="${ex.startWeight||'—'}" inputmode="decimal" value="${pr?.weight||ex.startWeight||''}"></div>
          <div class="aex-inp-wrap"><div class="aex-inp-lbl">Reps</div>
            <input class="aex-inp" type="number" id="aex-r" placeholder="8" inputmode="numeric"></div>
          <div class="aex-inp-wrap"><div class="aex-inp-lbl">Rest (s)</div>
            <input class="aex-inp" type="number" id="aex-rest" placeholder="120" inputmode="numeric"></div>
        </div>
      </div>
      <button class="aex-log-btn" id="aex-log-set-btn">+ LOG SET ${sets.length+1}</button>
      ${sets.length>0?`<button class="aex-done-btn" id="aex-done-ex-btn">✓ DONE WITH THIS EXERCISE</button>`:''}
    </div>`;

  // Log set
  document.getElementById('aex-log-set-btn').addEventListener('click',()=>{
    const wt=parseFloat(document.getElementById('aex-w').value)||ex.startWeight||0;
    const rp=parseInt(document.getElementById('aex-r').value)||8;
    const rt=parseInt(document.getElementById('aex-rest').value)||120;
    if(!S.workoutLog[ds])S.workoutLog[ds]={};
    if(!S.workoutLog[ds][asCurrentEx])S.workoutLog[ds][asCurrentEx]={sets:[]};
    S.workoutLog[ds][asCurrentEx].sets.push({weight:wt,reps:rp,rest:rt});
    if(!S.exercisePR[ex.n]||wt>S.exercisePR[ex.n].weight)S.exercisePR[ex.n]={weight:wt,reps:rp,date:ds};
    if(S.streakLast!==today()){
      const yd=new Date();yd.setDate(yd.getDate()-1);
      const yds=yd.toISOString().slice(0,10);
      S.streak=(S.streakLast===yds||!S.streakLast)?S.streak+1:1;
      S.streakLast=today();
    }
    save();
    // Show rest timer
    const nextEx=asCurrentEx+1<w.exercises.length?w.exercises[asCurrentEx+1]:null;
    startRestTimer(rt,nextEx?nextEx.n:'Last exercise — finish strong!');
    renderActiveEx();
  });

  // Delete set
  body.querySelectorAll('.aex-set-del').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const si=parseInt(btn.dataset.si);
      S.workoutLog[ds][asCurrentEx].sets.splice(si,1);
      save();renderActiveEx();
    });
  });

  // Done with exercise
  const doneBtn=document.getElementById('aex-done-ex-btn');
  if(doneBtn)doneBtn.addEventListener('click',()=>advanceExercise());
};

function startRestTimer(secs,nextName){
  asRestTarget=secs;asRestRemaining=secs;
  document.getElementById('rest-next-info').textContent='Next: '+nextName;
  document.getElementById('rest-countdown').textContent=fmtTime(secs);
  document.getElementById('rest-overlay').classList.add('open');
  if(restTimerInterval)clearInterval(restTimerInterval);
  restTimerInterval=setInterval(()=>{
    asRestRemaining--;
    document.getElementById('rest-countdown').textContent=fmtTime(asRestRemaining);
    if(asRestRemaining<=0){
      clearInterval(restTimerInterval);
      document.getElementById('rest-overlay').classList.remove('open');
      if('vibrate' in navigator)navigator.vibrate([300,100,300]);
      showToast('⏱ Rest done — next set!');
    }
  },1000);
}

function fmtTime(s){
  return String(Math.floor(s/60)).padStart(2,'0')+':'+String(Math.max(0,s%60)).padStart(2,'0');
}

document.getElementById('rest-skip').addEventListener('click',()=>{
  clearInterval(restTimerInterval);
  document.getElementById('rest-overlay').classList.remove('open');
});

function advanceExercise(){
  const w=WORKOUTS[activeDayIdx];
  asCurrentEx++;
  if(asCurrentEx>=w.exercises.length){
    finishSession();
  }else{
    renderActiveEx();
    document.getElementById('as-body').scrollTop=0;
  }
}

document.getElementById('as-next-btn').addEventListener('click',advanceExercise);
document.getElementById('as-prev-btn').addEventListener('click',()=>{
  if(asCurrentEx>0){asCurrentEx--;renderActiveEx();}
});

document.getElementById('as-close').addEventListener('click',()=>{
  if(confirm('End session?')){closeActiveSession();}
});

function closeActiveSession(){
  clearInterval(asTimerInterval);
  clearInterval(restTimerInterval);
  document.getElementById('active-session').classList.remove('open');
  document.getElementById('rest-overlay').classList.remove('open');
  renderWorkout();renderHome();
}

function finishSession(){
  clearInterval(asTimerInterval);
  clearInterval(restTimerInterval);
  document.getElementById('rest-overlay').classList.remove('open');
  document.getElementById('active-session').classList.remove('open');

  const w=WORKOUTS[activeDayIdx];
  const ds=today();
  const wlog=S.workoutLog[ds]||{};
  let totalSets=0,totalReps=0;
  Object.values(wlog).forEach(el=>{
    if(el.sets){el.sets.forEach(s=>{totalSets++;totalReps+=s.reps||0;});}
  });

  // Estimate burn
  const lastW=S.bodyLogs[S.bodyLogs.length-1];
  const bodyWeight=lastW?lastW.weight:85;
  const elapsed=Math.floor((Date.now()-asSessionStart)/1000/60);
  const burn=Math.round(w.met*bodyWeight*elapsed/60);

  document.getElementById('sc-stats').innerHTML=`
    <div class="sc-stat"><div class="sc-stat-val">${totalSets}</div><div class="sc-stat-lbl">Sets</div></div>
    <div class="sc-stat"><div class="sc-stat-val">${totalReps}</div><div class="sc-stat-lbl">Reps</div></div>
    <div class="sc-stat"><div class="sc-stat-val">${elapsed}</div><div class="sc-stat-lbl">Minutes</div></div>
    <div class="sc-stat"><div class="sc-stat-val">${burn}</div><div class="sc-stat-lbl">Est. Burned</div></div>`;

  document.getElementById('session-complete').classList.add('open');

  // Show burn confirm
  document.getElementById('burn-estimate').textContent=burn;
  document.getElementById('burn-adjust').value=burn;
  document.getElementById('burn-sheet-sub').textContent=`${w.name} for ~${elapsed} min at ${bodyWeight}kg bodyweight:`;

  document.getElementById('sc-done-btn').addEventListener('click',()=>{
    document.getElementById('session-complete').classList.remove('open');
    openSheet('burn-sheet');
    renderWorkout();renderHome();
  },{once:true});
}

document.getElementById('burn-confirm').addEventListener('click',()=>{
  const b=parseInt(document.getElementById('burn-adjust').value)||0;
  S.burnLog[today()]=(S.burnLog[today()]||0)+b;
  save();closeSheets();renderCalories();renderHome();
  showToast(`🔥 ${b} kcal burn logged!`);
});

// ═══════════════════════════════════════════════════════════════
// BMR / TDEE CALCULATION
// ═══════════════════════════════════════════════════════════════
function calcBMR(){
  const last=S.bodyLogs[S.bodyLogs.length-1];
  const weight=last?last.weight:85;
  // Mifflin-St Jeor for male (adjust if needed) — age 25 assumed, 175cm
  const age=S.age||25; const height=S.height||175;
  return Math.round(10*weight + 6.25*height - 5*age + 5);
}
function calcNEAT(){return S.neat||150;}
function calcTDEE(){
  return calcBMR()+calcNEAT()+todayBurn();
}
function calcNetAvailable(){
  const tgt=S.calTarget||{kcal:2200};
  const burn=todayBurn();
  const tot=todayTotals();
  // Net = target + workout burn - eaten  (BMR always "available" as you eat to cover it)
  return tgt.kcal + burn - tot.kcal;
}

// ═══════════════════════════════════════════════════════════════
// CALORIES
// ═══════════════════════════════════════════════════════════════
function renderCalories(){
  document.getElementById('cal-date-lbl').textContent=new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
  const tot=todayTotals();
  const burn=todayBurn();
  const tgt=S.calTarget||{kcal:2200,p:140,c:240,f:60};
  const bmr=calcBMR();
  const neat=calcNEAT();
  const tdee=bmr+neat+burn;
  const net=Math.max(0,tgt.kcal+burn-tot.kcal);

  // Main ring display
  document.getElementById('cal-remain').textContent=net.toLocaleString();
  document.getElementById('cal-eaten').textContent=tot.kcal.toLocaleString();
  document.getElementById('cal-burned-txt').textContent=burn;

  // Outer ring: eaten / target — circumference 515
  const pct=Math.min(1,tot.kcal/tgt.kcal);
  document.getElementById('ring-arc').style.strokeDashoffset=515-515*pct;
  document.getElementById('ring-pct').textContent=Math.round(pct*100)+'%';

  // Inner ring: BMR burned through day — circumference 377
  const now=new Date();
  const dayPct=(now.getHours()*60+now.getMinutes())/(24*60);
  const bmrSoFar=Math.round(bmr*dayPct);
  document.getElementById('ring-bmr').style.strokeDashoffset=377-377*Math.min(1,bmrSoFar/tgt.kcal);

  // Macros
  document.getElementById('val-p').textContent=tot.p;
  document.getElementById('val-c').textContent=tot.c;
  document.getElementById('val-f').textContent=tot.f;
  const ct=S.calTarget||{p:140,c:240,f:60};
  document.getElementById('tgt-p').textContent=ct.p||140;
  document.getElementById('tgt-c').textContent=ct.c||240;
  document.getElementById('tgt-f').textContent=ct.f||60;
  document.getElementById('bar-p').style.width=Math.min(100,tot.p/(ct.p||140)*100)+'%';
  document.getElementById('bar-c').style.width=Math.min(100,tot.c/(ct.c||240)*100)+'%';
  document.getElementById('bar-f').style.width=Math.min(100,tot.f/(ct.f||60)*100)+'%';

  // TDEE breakdown
  document.getElementById('tdb-target').textContent=tgt.kcal;
  document.getElementById('tdb-bmr').textContent=bmr;
  document.getElementById('tdb-neat').textContent='~'+neat;
  document.getElementById('tdb-workout').textContent=burn;
  document.getElementById('tdb-total').textContent=tdee;

  // Quick foods
  const qg=document.getElementById('qfood-grid');qg.innerHTML='';
  QUICK_FOODS.forEach(f=>{
    const btn=document.createElement('div');btn.className='qfood';
    btn.innerHTML=`<div class="qfood-em">${f.icon}</div><div><div class="qfood-name">${f.name}</div><div class="qfood-kcal">${f.kcal} kcal · P:${f.p}g</div></div>`;
    btn.addEventListener('click',()=>{
      if(!S.calLog[today()])S.calLog[today()]=[];
      S.calLog[today()].push({...f,id:Date.now()});
      save();renderCalories();renderHome();
      showToast(`${f.icon} ${f.name} logged!`);
    });
    qg.appendChild(btn);
  });

  // Food list
  const fl=document.getElementById('food-log-list');
  const log=todayCalLog();
  if(!log.length){fl.innerHTML='<div style="color:var(--text3);font-size:14px;text-align:center;padding:28px;font-weight:400">No food logged yet</div>';return;}
  fl.innerHTML='';
  log.forEach((f,i)=>{
    const item=document.createElement('div');item.className='food-item fade-up';
    item.innerHTML=`<div class="food-em">${f.icon||'🍽'}</div>
      <div class="food-info"><div class="food-name">${f.name}</div><div class="food-macros">P:${f.p}g · C:${f.c}g · F:${f.f}g</div></div>
      <div class="food-kcal">${f.kcal}</div>
      <div class="food-del" data-i="${i}"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div>`;
    item.querySelector('.food-del').addEventListener('click',()=>{
      S.calLog[today()].splice(i,1);save();renderCalories();renderHome();
    });
    fl.appendChild(item);
  });
}

// FAB for food
const fab=document.createElement('button');
fab.style.cssText='position:fixed;right:20px;bottom:calc(72px + env(safe-area-inset-bottom,0px));width:52px;height:52px;border-radius:16px;background:var(--accent);color:#fff;border:none;cursor:pointer;z-index:99;font-size:24px;display:none;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(255,59,48,.35);transition:opacity .15s,transform .12s';
fab.innerHTML='+';
fab.addEventListener('click',()=>{if(currentPage==='cal')openSheet('food-sheet');if(currentPage==='profile')openSheet('body-sheet');});
fab.addEventListener('mousedown',()=>fab.style.transform='scale(.93)');
fab.addEventListener('mouseup',()=>fab.style.transform='scale(1)');
document.getElementById('app').appendChild(fab);

document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    fab.style.display=(btn.dataset.page==='cal'||btn.dataset.page==='profile')?'flex':'none';
  });
});

// Food save
document.getElementById('food-save').addEventListener('click',()=>{
  const name=document.getElementById('f-name').value.trim();
  const kcal=parseInt(document.getElementById('f-kcal').value)||0;
  const p=parseInt(document.getElementById('f-p').value)||0;
  const c=parseInt(document.getElementById('f-c').value)||0;
  const f=parseInt(document.getElementById('f-f').value)||0;
  if(!name||!kcal){showToast('Add name and calories');return;}
  if(!S.calLog[today()])S.calLog[today()]=[];
  S.calLog[today()].push({name,kcal,p,c,f,icon:'🍽',id:Date.now()});
  save();['f-name','f-kcal','f-p','f-c','f-f'].forEach(id=>document.getElementById(id).value='');
  closeSheets();renderCalories();renderHome();
  showToast('✅ '+name+' logged!');
});

// ═══════════════════════════════════════════════════════════════
// REPORTS
// ═══════════════════════════════════════════════════════════════
let reportPeriod='week';
document.getElementById('report-tabs').querySelectorAll('.r-tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.r-tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    reportPeriod=tab.dataset.period;
    renderReports(reportPeriod);
  });
});

function getDateRange(period){
  const now=new Date();
  const end=new Date(now);end.setHours(23,59,59,999);
  const start=new Date(now);
  if(period==='week')start.setDate(now.getDate()-6);
  else if(period==='month')start.setDate(now.getDate()-29);
  else if(period==='quarter')start.setDate(now.getDate()-89);
  else start.setDate(now.getDate()-364);
  start.setHours(0,0,0,0);
  return{start,end};
}

function getDatesInRange(start,end){
  const dates=[];const d=new Date(start);
  while(d<=end){dates.push(d.toISOString().slice(0,10));d.setDate(d.getDate()+1);}
  return dates;
}

function renderReports(period){
  const{start,end}=getDateRange(period);
  const dates=getDatesInRange(start,end);
  const tgt=S.calTarget;
  const BMR=1900; // ~kcal/day at target weight

  let totalConsumed=0,totalBurned=0,sessions=0;
  dates.forEach(d=>{
    const log=S.calLog[d]||[];
    totalConsumed+=log.reduce((a,f)=>a+(f.kcal||0),0);
    totalBurned+=S.burnLog[d]||0;
    if(S.workoutLog[d]&&Object.keys(S.workoutLog[d]).length>0)sessions++;
  });
  const bmrTotal=BMR*dates.length;
  const netDeficit=bmrTotal+totalBurned-totalConsumed;
  const label=period==='week'?'This Week':period==='month'?'This Month':period==='quarter'?'This Quarter':'This Year';

  // Deficit card
  document.getElementById('deficit-num').textContent=Math.max(0,netDeficit).toLocaleString();
  document.getElementById('deficit-sub').textContent=netDeficit>0?`${label}: You're in a deficit — fat loss happening`:`${label}: Eat less or move more to create deficit`;
  document.getElementById('deficit-card')||0;
  document.getElementById('r-consumed').textContent=totalConsumed.toLocaleString();
  document.getElementById('r-burned').textContent=totalBurned.toLocaleString();
  document.getElementById('r-bmr').textContent=bmrTotal.toLocaleString();

  // Deficit card color
  const dc=document.querySelector('.deficit-card');
  if(netDeficit>0){
    dc.style.background='linear-gradient(135deg,rgba(76,175,125,.15),rgba(76,175,125,.05))';
    dc.style.borderColor='rgba(76,175,125,.3)';
    document.querySelector('.deficit-title').style.color='var(--green)';
    document.getElementById('deficit-num').parentElement.style.color='var(--green)';
  }else{
    dc.style.background='linear-gradient(135deg,rgba(224,82,82,.1),rgba(224,82,82,.03))';
    dc.style.borderColor='rgba(224,82,82,.3)';
  }

  // KPIs
  const kpiGrid=document.getElementById('report-kpis');
  const avgCal=dates.length>0?Math.round(totalConsumed/dates.length):0;
  const bodyLogs=S.bodyLogs.filter(l=>l.date>=dates[0]);
  const firstW=bodyLogs[0]?.weight;const lastW=bodyLogs[bodyLogs.length-1]?.weight;
  const wChange=firstW&&lastW?+(lastW-firstW).toFixed(1):null;

  kpiGrid.innerHTML=`
    <div class="kpi-card">
      <div class="kpi-val">${sessions}<em>x</em></div>
      <div class="kpi-lbl">Sessions</div>
      <div class="kpi-change good">Active days</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-val">${avgCal}<em>c</em></div>
      <div class="kpi-lbl">Avg Daily Cal</div>
      <div class="kpi-change ${avgCal>tgt.kcal?'bad':'good'}">${avgCal>tgt.kcal?'Over target':'On target'}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-val">${lastW||'—'}<em>kg</em></div>
      <div class="kpi-lbl">Current Weight</div>
      <div class="kpi-change ${wChange<0?'good':'bad'}">${wChange!==null?(wChange>0?'+':'')+wChange+'kg':'No data'}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-val">${S.streak}<em>d</em></div>
      <div class="kpi-lbl">Streak</div>
      <div class="kpi-change good">Keep going</div>
    </div>`;

  document.getElementById('weight-chart-title').textContent='WEIGHT — '+label.toUpperCase();

  // Weight chart
  renderLineChart('weight-chart',bodyLogs.map(l=>l.weight),'kg','#e8c547');
  // Body chart (waist)
  renderLineChart('body-chart',bodyLogs.filter(l=>l.waist).map(l=>l.waist),'in','#5b8dee');

  // Strength progression
  const epList=document.getElementById('ex-prog-list');epList.innerHTML='';
  const tracked=['Smith Machine Bench Press','Smith Machine Squat','Smith Machine RDL','DB Shoulder Press (seated)','Lateral Raises (DB)'];
  tracked.forEach(name=>{
    const pr=S.exercisePR[name];
    // Find starting weight from exercises data
    const exDef=WORKOUTS.flatMap(w=>w.exercises).find(e=>e.n===name);
    const startW=exDef?.startWeight||0;
    if(!pr&&!startW)return;
    const card=document.createElement('div');card.className='ex-prog-card';
    const gain=pr&&startW>0?+(pr.weight-startW).toFixed(1):null;
    card.innerHTML=`
      <div class="ex-prog-name">${name}</div>
      <div class="ex-prog-nums">
        <div class="ex-prog-start">Started: ${startW}kg</div>
        <div class="ex-prog-now">${pr?pr.weight+'kg × '+pr.reps+' reps':'No data yet'}</div>
      </div>
      ${gain!==null?`<div class="prog-track"><div class="prog-fill" style="width:${Math.min(100,Math.abs(gain)/30*100)+'%'}"></div></div>
      <div style="font-size:10px;color:var(--green);margin-top:4px">+${gain}kg from start</div>`:''}`;
    epList.appendChild(card);
  });
}

function renderLineChart(svgId,vals,unit,color){
  const svg=document.getElementById(svgId);
  svg.innerHTML='';
  const W=340;
  const H=svgId==='weight-chart'?180:160;
  const pad={top:20,bottom:24,left:16,right:16};
  if(!vals||vals.length<2){
    svg.innerHTML=`<text x="${W/2}" y="${H/2}" text-anchor="middle" fill="var(--text3)" font-size="12" font-family="-apple-system,sans-serif">Log data to see chart</text>`;
    return;
  }
  const min=Math.min(...vals),max=Math.max(...vals);
  const range=max-min||1;
  const pts=vals.map((v,i)=>{
    const x=pad.left+i/(vals.length-1)*(W-pad.left-pad.right);
    const y=pad.top+(1-(v-min)/range)*(H-pad.top-pad.bottom);
    return[x,y];
  });
  const pathD='M'+pts.map(p=>p[0].toFixed(1)+','+p[1].toFixed(1)).join(' L');
  const areaD=pathD+` L${pts[pts.length-1][0]},${H-pad.bottom} L${pts[0][0]},${H-pad.bottom} Z`;
  const gid='cg'+svgId;
  // Grid lines
  const gridLines=[0,.25,.5,.75,1].map(t=>{
    const y=pad.top+t*(H-pad.top-pad.bottom);
    const val=(max-t*range).toFixed(1);
    return `<line x1="${pad.left}" y1="${y.toFixed(1)}" x2="${W-pad.right}" y2="${y.toFixed(1)}" stroke="var(--border)" stroke-width="0.5"/>
      <text x="${pad.left-4}" y="${(y+3).toFixed(1)}" text-anchor="end" fill="var(--text4)" font-size="9" font-family="-apple-system,sans-serif">${val}</text>`;
  }).join('');
  svg.innerHTML=`<defs>
    <linearGradient id="${gid}" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="${color}" stop-opacity=".25"/>
      <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
    </linearGradient></defs>
    ${gridLines}
    <path d="${areaD}" fill="url(#${gid})"/>
    <path d="${pathD}" fill="none" stroke="${color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
    ${pts.map((p,i)=>`<circle cx="${p[0].toFixed(1)}" cy="${p[1].toFixed(1)}" r="4" fill="${color}" stroke="var(--bg)" stroke-width="2"/>`).join('')}
    <text x="${pts[pts.length-1][0]}" y="${(pts[pts.length-1][1]-12).toFixed(1)}" text-anchor="middle" fill="${color}" font-size="11" font-weight="700" font-family="-apple-system,sans-serif">${vals[vals.length-1]}${unit}</text>`;
}

// ═══════════════════════════════════════════════════════════════
// PROFILE
// ═══════════════════════════════════════════════════════════════
document.getElementById('log-body-btn').addEventListener('click',()=>openSheet('body-sheet'));
document.getElementById('pu-up').addEventListener('click',()=>{S.pushups++;document.getElementById('pushup-val').textContent=S.pushups;save();});
document.getElementById('pu-dn').addEventListener('click',()=>{S.pushups=Math.max(0,S.pushups-1);document.getElementById('pushup-val').textContent=S.pushups;save();});

// ═══════════════════════════════════════════════════════════════
// WEIGHT-BASED CALORIE PRESETS
// ═══════════════════════════════════════════════════════════════
const WEIGHT_PRESETS = [
  {maxKg:92, kcal:2200, p:140, c:240, f:60, label:'90–92 kg'},
  {maxKg:89, kcal:2100, p:140, c:228, f:58, label:'85–89 kg'},
  {maxKg:84, kcal:2000, p:140, c:218, f:55, label:'80–84 kg'},
  {maxKg:79, kcal:1900, p:140, c:205, f:52, label:'75–79 kg'},
  {maxKg:74, kcal:1850, p:140, c:198, f:50, label:'72–74 kg'},
  {maxKg:0,  kcal:1850, p:140, c:198, f:50, label:'< 72 kg'},
];

function getPresetForWeight(kg){
  return WEIGHT_PRESETS.find(p=>kg<=p.maxKg) || WEIGHT_PRESETS[WEIGHT_PRESETS.length-1];
}

function getWeekAvgWeight(){
  // Last 7 days of body logs
  const cutoff=new Date();cutoff.setDate(cutoff.getDate()-6);cutoff.setHours(0,0,0,0);
  const recent=S.bodyLogs.filter(l=>l.weight&&new Date(l.date)>=cutoff);
  if(!recent.length)return null;
  const avg=recent.reduce((a,l)=>a+l.weight,0)/recent.length;
  return {avg:+avg.toFixed(1), count:recent.length};
}

let pendingPreset=null;

document.getElementById('body-save').addEventListener('click',()=>{
  const w=parseFloat(document.getElementById('bl-w').value);
  const ws=parseFloat(document.getElementById('bl-ws').value);
  const rhr=parseInt(document.getElementById('bl-rhr').value);
  const sl=parseFloat(document.getElementById('bl-sl').value);
  if(!w){showToast('Enter at least your weight');return;}
  S.bodyLogs.push({date:today(),weight:w,waist:ws||null,rhr:rhr||null,sleep:sl||null});
  save();['bl-w','bl-ws','bl-rhr','bl-sl'].forEach(id=>document.getElementById(id).value='');
  closeSheets();renderProfile();renderHome();
  showToast('📊 Stats saved!');

  // Check if calorie adjustment is needed
  const result=getWeekAvgWeight();
  if(!result)return;
  const {avg, count}=result;
  const suggested=getPresetForWeight(avg);
  const cur=S.calTarget||{kcal:2200};

  // Only suggest if kcal would actually change
  if(suggested.kcal===cur.kcal)return;

  // Show suggestion sheet after a short delay
  pendingPreset=suggested;
  setTimeout(()=>{
    const useAvg=count>=3;
    const weightDesc=useAvg
      ?`${avg} kg (avg of ${count} logs this week)`
      :`${w} kg (latest log — need 3+ this week for avg)`;
    document.getElementById('wss-avg-weight').textContent=avg+' kg';
    document.getElementById('wss-cur-kcal').textContent=(cur.kcal||'—')+' kcal';
    document.getElementById('wss-new-kcal').textContent=suggested.kcal+' kcal';
    document.getElementById('wss-sub').textContent=
      useAvg
        ? `Your ${count}-day average is ${avg} kg. Your calories should adjust for next week.`
        : `Based on your latest weight (${w} kg). Log more this week for a 7-day average.`;
    document.getElementById('wss-macro-preview').innerHTML=
      `New targets: <strong style="color:var(--text)">${suggested.kcal} kcal</strong> &nbsp;·&nbsp; `+
      `P: <strong style="color:var(--blue)">${suggested.p}g</strong> &nbsp;·&nbsp; `+
      `C: <strong style="color:var(--accent)">${suggested.c}g</strong> &nbsp;·&nbsp; `+
      `F: <strong style="color:var(--amber)">${suggested.f}g</strong>`;
    openSheet('weight-suggest-sheet');
  }, 600);
});

document.getElementById('wss-apply').addEventListener('click',()=>{
  if(!pendingPreset)return;
  S.calTarget={kcal:pendingPreset.kcal, p:pendingPreset.p, c:pendingPreset.c, f:pendingPreset.f};
  save();
  closeSheets();
  updateSettingsDisplay();
  renderCalories();
  renderHome();
  showToast(`✅ Calories updated to ${pendingPreset.kcal} kcal`);
  pendingPreset=null;
});

document.getElementById('wss-dismiss').addEventListener('click',()=>{
  closeSheets();
  pendingPreset=null;
  showToast('Kept current targets');
});

function renderProfile(){
  document.getElementById('pushup-val').textContent=S.pushups||0;
  const logs=S.bodyLogs;
  const last=logs[logs.length-1];
  const prev=logs[logs.length-2];

  const bm=document.getElementById('body-metrics');
  const metrics=[
    {id:'bm-w',val:last?.weight,prev:prev?.weight,unit:'kg',lbl:'Weight',lower:true},
    {id:'bm-ws',val:last?.waist,prev:prev?.waist,unit:'in',lbl:'Waist',lower:true},
    {id:'bm-rhr',val:last?.rhr,prev:prev?.rhr,unit:'bpm',lbl:'Resting HR',lower:true},
    {id:'bm-sl',val:last?.sleep,prev:prev?.sleep,unit:'hr',lbl:'Sleep',lower:false},
  ];
  bm.innerHTML='';
  metrics.forEach(m=>{
    const diff=m.val&&m.prev?+(m.val-m.prev).toFixed(1):null;
    const better=diff!==null?(m.lower?diff<0:diff>0):null;
    bm.innerHTML+=`<div class="bm-card">
      <div class="bm-val">${m.val!=null?m.val:'—'}<em>${m.unit}</em></div>
      <div class="bm-lbl">${m.lbl}</div>
      <div class="bm-chg" style="color:${better===null?'var(--text3)':better?'var(--green)':'var(--red)'}">
        ${diff!==null?(diff>0?'+':'')+diff+m.unit:''}</div>
    </div>`;
  });

  // Progress bars — use current phase targets
  const ph=getCurrentPhase();
  const startW=92,targetW=ph.year===2?68:73;
  const curW=last?.weight||startW;
  document.getElementById('prog-w').style.width=Math.min(100,Math.max(0,(startW-curW)/(startW-targetW)*100))+'%';
  document.getElementById('prog-w-lbl').textContent=`${startW} → ${targetW} kg (Phase ${ph.id})`;

  const startWs=38,targetWs=ph.year===2?27:30;
  const curWs=last?.waist||startWs;
  document.getElementById('prog-ws').style.width=Math.min(100,Math.max(0,(startWs-curWs)/(startWs-targetWs)*100))+'%';

  // Phase targets card
  renderPhaseTargetsCard();

  // Milestones list
  renderMilestones();
}

// ═══════════════════════════════════════════════════════════════
// PLAN PHASES DATA (from 2-Year Plan PDF)
// ═══════════════════════════════════════════════════════════════
const PLAN_PHASES=[
  {id:1,year:1,months:'1–3',name:'Foundation',focus:'Learn movements, build cardio base, lose first 10 kg',weight:'82–88 kg',waist:'35–36 in',cardio:'Walk 30 min, HR < 140',kcal:2200,protein:140,carbs:240,fat:60,
   cal:{kcal:2200,p:140,c:240,f:60},body:{weight:'82–88 kg',waist:'35–36 in'},color:'#e8c547',
   gym:'Learning form, small PRs',look:'Slightly leaner, energy better',running:'Brisk walk only (20–25 min)',
   notes:'Zero running for first 8 weeks. Zone 2 walks only. Walk to gym every session — 2 km free cardio daily.'},
  {id:2,year:1,months:'4–6',name:'Walk-Run',focus:'Introduce running, strength PRs, visible fat loss',weight:'77–82 kg',waist:'33–35 in',cardio:'Run 5 min non-stop',kcal:2000,protein:140,carbs:218,fat:55,
   cal:{kcal:2000,p:140,c:218,f:55},body:{weight:'77–82 kg',waist:'33–35 in'},color:'#e8a247',
   gym:'Consistent PRs, all compounds',look:'Noticeably leaner, jawline thinner',running:'Walk-run intervals → 20 min easy run',
   notes:'Start jogging intervals. Walk 3 min / Jog 1 min × 6. HR stays under 152 bpm.'},
  {id:3,year:1,months:'7–9',name:'Endurance',focus:'5K running, physique taking shape, strength base',weight:'74–77 kg',waist:'31–33 in',cardio:'Run 5K continuously',kcal:1900,protein:140,carbs:205,fat:52,
   cal:{kcal:1900,p:140,c:205,f:52},body:{weight:'74–77 kg',waist:'31–33 in'},color:'#e07a47',
   gym:'Real PRs, push-ups 15+',look:'Athletic, lean, clear muscle definition',running:'3 easy runs + 1 long run up to 8 km',
   notes:'Push-ups should exceed 15 by Month 7. V-taper beginning to emerge. 5K continuous run achieved.'},
  {id:4,year:1,months:'10–12',name:'Race + Shred',focus:'10K training, shredded look, Year 1 goal achieved',weight:'72–74 kg',waist:'30 in',cardio:'10K in 30 min ✓',kcal:1850,protein:140,carbs:198,fat:50,
   cal:{kcal:1850,p:140,c:198,f:50},body:{weight:'72–74 kg',waist:'30 in'},color:'#4caf7d',
   gym:'Intermediate strength across all lifts',look:'Lean, dense, shredded, fast',running:'2 easy + 1 tempo + 1 long run · pace 3:00/km',
   notes:'YEAR 1 GOAL ACHIEVED. 72–74 kg. 30-inch waist. 5+ unassisted pull-ups. Shredded V-taper.'},
  {id:5,year:2,months:'13–15',name:'Recomp',focus:'Maintain weight, swap remaining fat for lean muscle',weight:'70–73 kg',waist:'29–30 in',cardio:'10K under 28 min',kcal:1950,protein:155,carbs:200,fat:55,
   cal:{kcal:1950,p:155,c:200,f:55},body:{weight:'70–73 kg',waist:'29–30 in'},color:'#5b8dee',
   gym:'Bench 65+ kg · 8+ pull-ups · RDL 80+ kg',look:'Leaner at same weight — recomp working',running:'Continuous easy run 25–30 min Zone 2',
   notes:'Scale barely moves — mirror tells a different story. Body fat dropping while muscle increases. Trust the process.'},
  {id:6,year:2,months:'16–18',name:'Strength',focus:'Push strength ceiling, athletic conditioning upgrades',weight:'69–71 kg',waist:'28–29 in',cardio:'10K under 27 min',kcal:2050,protein:160,carbs:212,fat:58,
   cal:{kcal:2050,p:160,c:212,f:58},body:{weight:'69–71 kg',waist:'28–29 in'},color:'#9c59d1',
   gym:'Bench 72+ kg · weighted pull-ups · push-ups 35+',look:'Visibly more muscular and shredded — people notice',running:'Tempo: 5 min warm-up + 15 min Zone 3–4 + 5 min cooldown',
   notes:'Periodisation kicks in: Volume week → Strength week → Volume week → Deload week. Never skip Deload.'},
  {id:7,year:2,months:'19–21',name:'Elite Lean',focus:'Shredded maintenance, power output, speed phases',weight:'68–70 kg',waist:'27–28 in',cardio:'10K under 26.5 min',kcal:1950,protein:160,carbs:200,fat:55,
   cal:{kcal:1950,p:160,c:200,f:55},body:{weight:'68–70 kg',waist:'27–28 in'},color:'#e05252',
   gym:'Peak compound lifts · strides dialled in',look:'Elite lean look. The physique that earns respect.',running:'Intervals: 6 × 3 min Zone 4 with 90 sec easy recovery',
   notes:'10–12% body fat range. The genuinely shredded range. Dragon flag progression added to core work.'},
  {id:8,year:2,months:'22–24',name:'Mastery',focus:'Peak physique locked in, sustainable lifestyle, race PR',weight:'68–70 kg',waist:'27 in',cardio:'10K under 26 min',kcal:2000,protein:165,carbs:205,fat:57,
   cal:{kcal:2000,p:165,c:205,f:57},body:{weight:'68–70 kg',waist:'27 in'},color:'#e8c547',
   gym:'Intermediate-advanced across all lifts',look:'Physique proud of for life. Done.',running:'Race intervals: 4 × 1 km at 2:36/km pace',
   notes:'THE FINAL FORM. 68–70 kg. 27-inch waist. Dense lean muscle. 10K in 26 minutes. Built on dal, eggs, and a Smith machine.'},
];

const MILESTONES=[
  {period:'Week 1–4',weight:'88–91 kg',waist:'~37.5 in',cardio:'Walk 25 min, HR settling',gym:'Learning form each session',look:'Very slightly leaner, energy better'},
  {period:'Week 5–8',weight:'84–87 kg',waist:'~36 in',cardio:'Walk 30 min, HR < 140',gym:'Consistent PRs, small weight jumps',look:'Noticeably leaner, jawline thinner'},
  {period:'Week 9–12',weight:'79–82 kg',waist:'~34 in',cardio:'Walk-jog intervals, HR < 152',gym:'Real PRs on all compounds',look:'V-taper emerging, arms defined'},
  {period:'Month 4–6',weight:'74–77 kg',waist:'~32 in',cardio:'Run 5K continuously',gym:'Push-ups 15+, solid compounds',look:'Athletic, lean, clear muscle definition'},
  {period:'Month 7–9',weight:'72–75 kg',waist:'~31 in',cardio:'Run 8K easy',gym:'5+ unassisted pull-ups',look:'Shredded, clear V-taper visible'},
  {period:'Month 10–12',weight:'72–74 kg',waist:'~30 in',cardio:'10K in 30 min ✓',gym:'Intermediate strength — Year 1 done',look:'Lean, dense, shredded, fast — GOAL HIT'},
  {period:'Month 13–15',weight:'70–73 kg',waist:'~29–30 in',cardio:'10K under 28 min',gym:'Bench 65+ kg · 8 pull-ups',look:'Leaner at same weight — recomp evident'},
  {period:'Month 16–18',weight:'69–71 kg',waist:'~28–29 in',cardio:'10K under 27 min',gym:'Bench 72+ kg · weighted pull-ups',look:'More muscular and shredded — people notice'},
  {period:'Month 19–21',weight:'68–70 kg',waist:'~28 in',cardio:'10K under 26.5 min',gym:'Peak compound lifts across all sessions',look:'Elite lean look. Earns genuine respect.'},
  {period:'Month 22–24',weight:'68–70 kg',waist:'~27 in',cardio:'10K under 26 min',gym:'Intermediate-advanced across all lifts',look:'Physique proud of for life. Done.'},
];

function getCurrentPhase(){
  return PLAN_PHASES.find(p=>p.id===(S.planPhase||1))||PLAN_PHASES[0];
}

function renderPhaseOptionsInSheet(){
  const container=document.getElementById('phase-options');
  container.innerHTML='';
  const cur=S.planPhase||1;
  PLAN_PHASES.forEach(ph=>{
    const el=document.createElement('div');
    el.className='phase-option-card'+(ph.id===cur?' selected':'');
    el.innerHTML=`
      <div class="phase-option-year">${ph.year===1?'Year 1':'Year 2'} · Month ${ph.months}</div>
      <div class="phase-option-name">Phase ${ph.id} — ${ph.name}</div>
      <div class="phase-option-months">${ph.focus}</div>`;
    el.addEventListener('click',()=>{
      S.planPhase=ph.id;
      // Auto-update calorie targets to match phase
      S.calTarget={kcal:ph.kcal,protein:ph.protein,carbs:ph.carbs,fat:ph.fat};
      save();
      updateSettingsDisplay();
      renderPhaseTargetsCard();
      renderMilestones();
      closeSheets();
      showToast(`📅 Phase ${ph.id}: ${ph.name} selected`);
    });
    container.appendChild(el);
  });
}

function updateSettingsDisplay(){
  const ph=getCurrentPhase();
  const t=S.calTarget||{kcal:ph.kcal,p:ph.protein,c:ph.carbs,f:ph.fat};
  // Support both old format (protein/carbs/fat) and new format (p/c/f)
  const pVal=t.p||t.protein||0;
  const cVal=t.c||t.carbs||0;
  const fVal=t.f||t.fat||0;
  document.getElementById('cal-target-sub').textContent=
    `${t.kcal.toLocaleString()} kcal · P:${pVal}g C:${cVal}g F:${fVal}g`;
  document.getElementById('plan-phase-sub').textContent=
    `Year ${ph.year} · Month ${ph.months} · ${ph.name}`;
}

function renderPhaseTargetsCard(){
  const ph=getCurrentPhase();
  const container=document.getElementById('phase-targets-card');
  container.innerHTML=`<div class="phase-target-card">
    <div class="phase-target-title">Phase ${ph.id} — ${ph.name}</div>
    <div class="phase-target-sub">Year ${ph.year} · Month ${ph.months}<br>${ph.focus}</div>
    <div class="phase-targets-grid">
      <div class="phase-target-item">
        <div class="phase-target-item-val">${ph.weight}</div>
        <div class="phase-target-item-lbl">Target Weight</div>
      </div>
      <div class="phase-target-item">
        <div class="phase-target-item-val">${ph.waist}</div>
        <div class="phase-target-item-lbl">Target Waist</div>
      </div>
      <div class="phase-target-item">
        <div class="phase-target-item-val">${ph.kcal.toLocaleString()} kcal</div>
        <div class="phase-target-item-lbl">Daily Calories</div>
      </div>
      <div class="phase-target-item">
        <div class="phase-target-item-val">${ph.protein}g P · ${ph.carbs}g C</div>
        <div class="phase-target-item-lbl">Protein · Carbs</div>
      </div>
      <div class="phase-target-item" style="grid-column:1/-1">
        <div class="phase-target-item-val">${ph.cardio}</div>
        <div class="phase-target-item-lbl">Cardio Target</div>
      </div>
    </div>
  </div>`;
}

function renderMilestones(){
  const list=document.getElementById('milestones-list');
  list.innerHTML='';
  const curW=(S.bodyLogs[S.bodyLogs.length-1]?.weight)||92;
  MILESTONES.forEach((m,i)=>{
    // Determine status
    const targetW=parseFloat(m.weight.split('–')[1]||m.weight)||92;
    const isYear2=m.period.includes('13')||m.period.includes('16')||m.period.includes('19')||m.period.includes('22');
    let status='future';
    if(curW<=targetW+1&&!isYear2) status='current';
    if(curW<targetW-1) status='achieved';
    if(isYear2&&curW<=74) status='future';

    const el=document.createElement('div');
    el.className=`milestone-card ${status==='achieved'?'achieved':status==='current'?'current-phase':'future'}`;
    el.innerHTML=`
      <div class="milestone-badge ${status}">${status==='achieved'?'✓ Done':status==='current'?'● Now':'Future'}</div>
      <div class="milestone-period">${m.period}${m.period.includes('13')||m.period.includes('16')||m.period.includes('19')||m.period.includes('22')?' · Year 2':''}</div>
      <div class="milestone-title">${m.weight} · ${m.waist}</div>
      <div class="milestone-stats-row">
        <div class="milestone-stat">
          <div class="milestone-stat-val" style="font-size:11px">${m.cardio}</div>
          <div class="milestone-stat-lbl">Cardio</div>
        </div>
      </div>
      <div style="font-size:11px;color:var(--text2);margin-top:8px;line-height:1.4;font-style:italic">${m.look}</div>`;
    list.appendChild(el);
  });
}

// ═══════════════════════════════════════════════════════════════
// SETTINGS LISTENERS
// ═══════════════════════════════════════════════════════════════
document.getElementById('cal-target-row').addEventListener('click',()=>openSheet('cal-target-sheet'));
document.getElementById('plan-phase-row').addEventListener('click',()=>{
  renderPhaseOptionsInSheet();
  openSheet('phase-sheet');
});

// View Future Targets listener
document.getElementById('view-targets-row').addEventListener('click',()=>{
  renderTargetPhaseSelect();
  renderTargetPhasePreview(S.planPhase||1);
  openSheet('targets-sheet');
});
document.getElementById('target-phase-select').addEventListener('change',function(){
  renderTargetPhasePreview(parseInt(this.value));
});

// Calorie target preset select
document.getElementById('cal-preset-select').addEventListener('change',function(){
  const v=this.value;
  document.getElementById('cal-custom-fields').style.display=v==='custom'?'block':'none';
  if(v&&v!=='custom'){
    const [kcal,protein,carbs,fat]=v.split('|').map(Number);
    document.getElementById('ct-kcal').value=kcal;
    document.getElementById('ct-p').value=protein;
    document.getElementById('ct-c').value=carbs;
    document.getElementById('ct-f').value=fat;
    document.getElementById('cal-custom-fields').style.display='block';
  }
});

document.getElementById('cal-target-save').addEventListener('click',()=>{
  const kcal=parseInt(document.getElementById('ct-kcal').value)||S.calTarget?.kcal||2200;
  const protein=parseInt(document.getElementById('ct-p').value)||S.calTarget?.protein||140;
  const carbs=parseInt(document.getElementById('ct-c').value)||S.calTarget?.carbs||240;
  const fat=parseInt(document.getElementById('ct-f').value)||S.calTarget?.fat||60;
  S.calTarget={kcal,protein,carbs,fat};
  save();
  updateSettingsDisplay();
  renderPhaseTargetsCard();
  closeSheets();
  showToast('✅ Calorie targets saved!');
});

// Init settings display on load
updateSettingsDisplay();
renderPhaseTargetsCard();
renderMilestones();

// ═══════════════════════════════════════════════════════════════
// NEW SETTINGS FUNCTIONS — Roadmap + Phase Target Browser
// ═══════════════════════════════════════════════════════════════
function renderRoadmapCard(){
  const card=document.getElementById('roadmap-card');
  if(!card)return;
  const curId=S.planPhase||1;
  card.innerHTML=PLAN_PHASES.map(ph=>{
    const isCur=ph.id===curId;
    const isPast=ph.id<curId;
    const dotColor=isPast?'var(--green)':isCur?ph.color:'var(--border2)';
    const nameColor=isCur?'var(--accent)':isPast?'var(--text2)':'var(--text)';
    return `<div class="roadmap-row" style="${isCur?'background:var(--accent-dim)':''}">
      <div class="roadmap-phase-dot" style="background:${dotColor};flex-shrink:0;width:10px;height:10px;border-radius:50%;margin-top:4px${isCur?';outline:2px solid '+ph.color+';outline-offset:2px':''}"></div>
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:1px">
          <div style="font-size:12px;font-weight:700;color:${nameColor}">Phase ${ph.id} — ${ph.name}</div>
          ${isCur?'<div style="font-size:8px;font-weight:700;color:var(--accent);letter-spacing:.8px;text-transform:uppercase;flex-shrink:0">YOU ARE HERE</div>':''}
          ${isPast?'<div style="font-size:10px;color:var(--green);flex-shrink:0">✓</div>':''}
        </div>
        <div style="font-size:10px;color:var(--text3);margin-bottom:1px">Y${ph.year} · Month ${ph.months} · ${ph.kcal.toLocaleString()} kcal</div>
        <div style="font-size:11px;color:var(--text2)">${ph.weight} · ${ph.waist} · ${ph.cardio}</div>
      </div>
    </div>`;
  }).join('');
}

function renderTargetPhaseSelect(){
  const sel=document.getElementById('target-phase-select');
  if(!sel)return;
  const curId=S.planPhase||1;
  sel.innerHTML=PLAN_PHASES.map(ph=>`
    <option value="${ph.id}" ${ph.id===curId?'selected':''}>
      Phase ${ph.id}: ${ph.name} · Y${ph.year} M${ph.months} · ${ph.kcal.toLocaleString()} kcal
    </option>`).join('');
}

function renderTargetPhasePreview(phaseId){
  const container=document.getElementById('target-phase-preview');
  if(!container)return;
  const ph=PLAN_PHASES.find(p=>p.id===phaseId)||PLAN_PHASES[0];
  const accentRgb=ph.year===2?'10,132,255':'255,59,48';
  container.innerHTML=`
    <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden">
      <div style="padding:12px 14px;border-bottom:1px solid var(--border);background:linear-gradient(90deg,rgba(${accentRgb},.12),transparent)">
        <div style="font-family:'Bebas Neue',cursive;font-size:20px;letter-spacing:1.5px;color:var(--text)">Phase ${ph.id} — ${ph.name}</div>
        <div style="font-size:11px;color:var(--text2);margin-top:2px">${ph.focus}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr">
        ${tCell('Calories',ph.kcal.toLocaleString(),'kcal')}
        ${tCell('Protein',ph.protein,'g')}
        ${tCell('Carbs',ph.carbs,'g')}
        ${tCell('Fat',ph.fat,'g')}
        ${tCell('Weight Target',ph.weight,'')}
        ${tCell('Waist Target',ph.waist,'')}
        ${tCellWide('Cardio Goal',ph.cardio)}
        ${tCellWide('Running Protocol',ph.running||'—')}
        ${tCellNote(ph.notes||'')}
      </div>
    </div>`;
}

function tCell(lbl,val,unit){
  return `<div style="padding:10px 14px;border-right:1px solid var(--border);border-bottom:1px solid var(--border)">
    <div style="font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;font-weight:700">${lbl}</div>
    <div style="font-family:'DM Mono',monospace;font-size:14px;color:var(--text);margin-top:2px;font-weight:500">${val}<span style="font-size:10px;color:var(--text3)">${unit?(' '+unit):''}</span></div>
  </div>`;
}
function tCellWide(lbl,val){
  return `<div style="padding:10px 14px;grid-column:span 2;border-bottom:1px solid var(--border)">
    <div style="font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;font-weight:700">${lbl}</div>
    <div style="font-size:12px;color:var(--text);margin-top:2px;line-height:1.4">${val}</div>
  </div>`;
}
function tCellNote(note){
  return `<div style="padding:10px 14px;grid-column:span 2">
    <div style="font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;font-weight:700">Coach Note</div>
    <div style="font-size:11px;color:var(--text2);margin-top:4px;line-height:1.5;font-style:italic">${note}</div>
  </div>`;
}

// ═══════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════
renderHome();
renderWorkout();
updateSettingsDisplay();
renderPhaseTargetsCard();
renderMilestones();
renderRoadmapCard();
setInterval(()=>{if(currentPage==='home')renderGymTime();},30000);
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('SW registered'))
        .catch(err => console.log('SW failed:', err));
    });
  }
</script>
</body>
</html>
